function Route(e,t){this.startLocation=e,this.endLocations=t,this.buyOrders={},this.buyOrders.completePages=[],this.buyOrders.complete=!1,this.buyOrders.pageBookend=PAGE_MULTIPLE,this.sellOrders={},this.itemIds=[],this.secondsToRefresh=60,this.asyncRefresher=null,this.asyncProgressUpdate=null,this.completed=!1,routes.push(this),this.routeId=routes.length-1}var routes=[];Route.prototype.className=function(){return"Route"},Route.prototype.startRoute=function(){var e,t=parseInt(this.startLocation.region),o=parseInt(this.startLocation.station);for(e=1;e<=PAGE_MULTIPLE;e++)"SELL"==orderTypeStart?this.getSellOrders(t,o,e,this.buyOrders):this.getBuyOrders(t,o,e,this.buyOrders);for(var s=0,r=0;r<this.endLocations.length;r++)if(this.endLocations[r].station!==this.startLocation.station){for(this.sellOrders[s]={},this.sellOrders[s].completePages=[],this.sellOrders[s].complete=!1,this.sellOrders[s].pageBookend=PAGE_MULTIPLE,t=parseInt(this.endLocations[r].region),o=parseInt(this.endLocations[r].station),e=1;e<=PAGE_MULTIPLE;e++)"BUY"==orderTypeEnd?this.getBuyOrders(t,o,e,this.sellOrders[s]):this.getSellOrders(t,o,e,this.sellOrders[s]);s+=1}$("#selection").hide()},Route.prototype.recalculateProgress=function(){for(var e=this.getNumberOfCompletePages(this.buyOrders),t=0,o=0;o<this.endLocations.length;o++)this.endLocations[o].station!==this.startLocation.station&&(e+=this.getNumberOfCompletePages(this.sellOrders[t]),t+=1);return e<=0?1:35*Math.log10(e)},Route.prototype.getBuyOrders=function(e,t,o,s){this.getOrders(e,t,o,s,BUY_ORDER)},Route.prototype.getSellOrders=function(e,t,o,s){this.getOrders(e,t,o,s,SELL_ORDER)},Route.prototype.getOrders=function(i,a,n,d,h){var e=marketEndpointBuilder(i,n,h),l=this;d.completePages[n]||$.ajax({type:"get",url:e,dataType:"json",contentType:"application/json",async:!0,success:function(e){if(incrementProgress(d,n),0!==e.length||d.complete){for(var t=0;t<e.length;t++)if(e[t].location_id===a){var o=e[t].type_id;d[o]||(d[o]=[]),d[o].push(e[t])}if(d.complete||l.getNumberOfCompletePages(d)!==d.pageBookend)l.executeOrders();else{var s=n+1;d.pageBookend=d.pageBookend+PAGE_MULTIPLE;for(var r=d.pageBookend;s<=r;s++)l.getOrders(i,a,s,d,h)}}else d.complete=!0,console.log("Completed "+a+" order fetch at "+n)},error:function(){if(displayError(),incrementProgress(d,n),d.complete||l.getNumberOfCompletePages(d)!==d.pageBookend)l.executeOrders();else{var e=n+1;d.pageBookend=d.pageBookend+PAGE_MULTIPLE;for(var t=d.pageBookend;e<=t;e++)l.getOrders(i,a,e,d,h)}}})},Route.prototype.getNumberOfCompletePages=function(e){for(var t=0,o=0;o<e.completePages.length;o++)e.completePages[o]&&t++;return t},Route.prototype.checkOrdersComplete=function(){for(var e=this.getNumberOfCompletePages(this.buyOrders)===this.buyOrders.pageBookend,t=this.buyOrders.complete,o=0,s=0;s<this.endLocations.length;s++)this.endLocations[s].station!==this.startLocation.station&&(e=e&&this.getNumberOfCompletePages(this.sellOrders[o])===this.sellOrders[o].pageBookend,t=t&&this.sellOrders[o].complete,o+=1);return e&&t},Route.prototype.executeOrders=function(){if(this.checkOrdersComplete()){for(itemId in hideError(),this.buyOrders)"completePages"!==itemId&&"complete"!==itemId&&"pageBookend"!==itemId&&this.itemIds.push(itemId);this.calculate()}},Route.prototype.clear=function(){this.startLocation=null,this.endLocations=null,this.buyOrders={},this.buyOrders.completePages=[],this.buyOrders.complete=!1,this.buyOrders.pageBookend=PAGE_MULTIPLE,this.sellOrders={},this.itemIds=[],this.secondsToRefresh=60,clearInterval(this.asyncRefresher),clearInterval(this.asyncProgressUpdate)},Route.prototype.asyncRefresh=function(){var e=this;this.asyncRefresher=setInterval(function(){e.secondsToRefresh<=0?(clearInterval(e.asyncRefresher),$("#refresh-timer").remove(),$("#buyingFooter").append('<div id="refresh-button"><input type="button" class="btn btn-default" onclick="refresh()" value="Refresh Table with Last Query"/></div>')):(rowAdded?$(".loading").hide():$(".loading").text("No trades found for your filters."),$("#refresh-timer").html("<p>Refresh allowed in: "+e.secondsToRefresh+" seconds."),e.secondsToRefresh--)},1e3)},Route.prototype.asyncProgress=function(){var e=this;this.asyncProgressUpdate=setInterval(function(){getTotalProgress(),100==totalProgress&&(clearInterval(e.asyncProgressUpdate),$("#buyingFooter").append('<div id="refresh-timer"></div>'),$(".tableLoadingIcon").hide(),createdRefresher||(createdRefresher=!0,e.asyncRefresh()))},2500)},Route.prototype.calculate=function(){for(this.asyncProgress();0!=this.itemIds.length;){executingCount++;var e=this.itemIds.splice(0,1)[0];0==this.itemIds.length&&(this.completed=!0),this.calculateNext(e)}},Route.prototype.calculateNext=function(e){var t=getMarketData(this.buyOrders[e],this.startLocation.station,"BUY"==orderTypeStart?BUY_ORDER:SELL_ORDER,e,!0);if(0<t.length){"SELL"==orderTypeStart&&"BUY"==orderTypeEnd||(t="BUY"==orderTypeStart?[t[0]]:[t[t.length-1]]);for(var o=!1,s=0,r=0;r<this.endLocations.length;r++)if(this.endLocations[r].station!==this.startLocation.station){var i=this.sellOrders[s],a=this.endLocations[r];if(i[e]){var n=getMarketData(i[e],a.station,"BUY"==orderTypeEnd?BUY_ORDER:SELL_ORDER,e,!0);if(0<n.length){"SELL"==orderTypeStart&&"BUY"==orderTypeEnd||(n="BUY"==orderTypeStart?[n[0]]:[n[n.length-1]]);var d={};d.region=a.region,d.station=a.station,o=!0,this.getItemInfo(e,t,n,d)}}s+=1}o||executingCount--}else executingCount--},Route.prototype.getItemInfo=function(e,t,o,s){for(var r=[],i=0;i<t.length;i++)for(var a=0;a<o.length;a++){var n=this.calculateRow(e,t[i][0],t[i][1],o[a][0],o[a][1],s);0<n.length&&r.push(n)}0<r.length?(r=r.sort(bestRowComparator),this.getItemWeight(e,this.createRowObject(r[0]))):executingCount--},Route.prototype.calculateRow=function(e,t,o,s,r,i){if(t<s&&0<s){var a=s*sales_tax/100,n=s-a-t;if(0<n){var d,h=(d=r<=o?r:o)*(s-t),l=d*a,c=h-l,u=d*t,p=n/t;if(c>=threshold_profit&&(100*p.toFixed(3)).toFixed(1)>=threshold_roi&&u<=threshold_cost)return[e,t,d,u,i,c,p,s,n,h,l]}}return[]},Route.prototype.getItemWeight=function(s,r){if(itemCache[s]){var e=itemCache[s].name,t=itemCache[s].weight;r.itemName=e,r.itemWeight=t,this.addRow(r),executingCount--}else{var i=this,o=getWeightEndpointBuilder(s);$.ajax({type:"get",url:o,dataType:"json",async:!0,cache:!1,contentType:"application/json",success:function(e){executingCount--;var t=e.name,o=e.packaged_volume;itemCache[s]={},itemCache[s].name=t,itemCache[s].weight=o,r.itemName=t,r.itemWeight=o,i.addRow(r)},error:function(e){404!=e.status&&"parsererror"!==e.statusText?i.getItemWeight(s,r):executingCount--}})}},Route.prototype.createRowObject=function(e){var t={};return t.itemId=e[0],t.buyPrice=e[1],t.quantity=e[2],t.buyCost=e[3],t.sellToStation=e[4],t.totalProfit=e[5],t.roi=e[6],t.sellPrice=e[7],t.perItemProfit=e[8],t.grossMargin=e[9],t.sellTax=e[10],t},Route.prototype.addRow=function(e){var t=e.itemWeight*e.quantity;if(!(t>threshold_weight||isSpamItem(e.itemName))){createDataTable();var o=e.sellToStation.station+this.startLocation.station+e.itemId+"_investigate",s=['<span id="'+o+'"data-itemId="'+e.itemId+'"data-itemName="'+e.itemName+'"data-routeId="'+this.routeId+'"data-sellStationId="'+e.sellToStation.station+'"><i class="fa fa-search-plus"></i></span>',e.itemName,this.startLocation.name,numberWithCommas(e.quantity),numberWithCommas(e.buyPrice.toFixed(2)),numberWithCommas(e.buyCost.toFixed(2)),getStationName(e.sellToStation.station),numberWithCommas(e.sellPrice.toFixed(2)),numberWithCommas(e.grossMargin.toFixed(2)),numberWithCommas(e.sellTax.toFixed(2)),numberWithCommas(e.totalProfit.toFixed(2)),numberWithCommas(e.perItemProfit.toFixed(2)),(100*e.roi.toFixed(3)).toFixed(1)+"%",numberWithCommas(t.toFixed(2))],r=$("#dataTable").dataTable().fnAddData(s);$("#dataTable").dataTable().fnGetNodes(r),$("#"+o).on("click",function(){var e=parseInt(this.dataset.itemid),t=this.dataset.itemname,o=routes[parseInt(this.dataset.routeid)].startLocation,s=parseInt(this.dataset.sellstationid);open_popup(e,t,o,s)}),rowAdded=!0}};