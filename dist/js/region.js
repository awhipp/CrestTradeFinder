function Region(e,t){this.startLocation=e,this.endLocations=t,this.buyOrders={},this.buyOrders.completePages=[],this.buyOrders.complete=!1,this.buyOrders.pageBookend=PAGE_MULTIPLE,this.sellOrders={},this.sellOrders.completePages=[],this.sellOrders.complete=!1,this.sellOrders.pageBookend=PAGE_MULTIPLE,this.regionRoutes=[],this.secondsToRefresh=60,this.asyncRefresher=null,this.asyncProgressUpdate=null,this.routesExecutor=null,this.security=setDefaultVal($("#security-threshold").val(),"NULL"),this.safety=setDefaultVal($("#route-preference").val(),"shortest"),this.completed=!1,this.includeCitadels=$("#include-citadels").is(":checked"),this.includeCitadels?$("#citadelsLine").show():$("#citadelsLine").hide(),routes.push(this)}var routes=[];Region.prototype.className=function(){return"Route"},Region.prototype.startRoute=function(){var e,t=parseInt(this.startLocation.id);for(e=1;e<=PAGE_MULTIPLE;e++)this.getSellOrders(t,e,this.buyOrders);for(t=parseInt(this.endLocations.id),e=1;e<=PAGE_MULTIPLE;e++)this.getBuyOrders(t,e,this.sellOrders);$("#selection").hide()},Region.prototype.recalculateProgress=function(){var e=this.getNumberOfCompletePages(this.buyOrders);return(e+=this.getNumberOfCompletePages(this.sellOrders))<=0?1:35*Math.log10(e)},Region.prototype.getBuyOrders=function(e,t,s){this.getOrders(e,t,s,BUY_ORDER)},Region.prototype.getSellOrders=function(e,t,s){this.getOrders(e,t,s,SELL_ORDER)},Region.prototype.getOrders=function(r,n,l,d){var e=marketEndpointBuilder(r,n,d),c=this;l.completePages[n]||$.ajax({type:"get",url:e,dataType:"json",contentType:"application/json",async:!0,success:function(e){if(incrementProgress(l,n),0!==e.length||l.complete){for(var t=0;t<e.length;t++){var s=e[t].location_id,a=e[t].type_id;l[s]||(l[s]={}),l[s][a]||(l[s][a]=[]),l[s][a].push(e[t])}if(l.complete||c.getNumberOfCompletePages(l)!==l.pageBookend)c.executeOrders();else{var o=n+1;l.pageBookend=l.pageBookend+PAGE_MULTIPLE;for(var i=l.pageBookend;o<=i;o++)c.getOrders(r,o,l,d)}}else l.complete=!0,console.log("Completed "+r+" order fetch at "+n)},error:function(){if(displayError(),incrementProgress(l,n),!l.complete&&c.getNumberOfCompletePages(l)===l.pageBookend){var e=n+1;l.pageBookend=l.pageBookend+PAGE_MULTIPLE;for(var t=l.pageBookend;e<=t;e++)c.getOrders(r,e,l,d)}}})},Region.prototype.getNumberOfCompletePages=function(e){for(var t=0,s=0;s<e.completePages.length;s++)e.completePages[s]&&t++;return t},Region.prototype.checkOrdersComplete=function(){var e=this.getNumberOfCompletePages(this.buyOrders)===this.buyOrders.pageBookend,t=this.buyOrders.complete;return e=e&&this.getNumberOfCompletePages(this.sellOrders)===this.sellOrders.pageBookend,t=t&&this.sellOrders.complete,e&&t},Region.regionRoutes=[],Region.prototype.executeOrders=function(){if(this.checkOrdersComplete()){for(startStationId in hideError(),this.buyOrders){var e={};if(e.region=this.startLocation.id,e.station=startStationId,!(999999999<startStationId)||this.includeCitadels)for(itemId in this.buyOrders[startStationId])if("completePages"!==itemId&&"complete"!==itemId&&"pageBookend"!==itemId){var t=getMarketData(this.buyOrders[startStationId][itemId],e.station,SELL_ORDER,itemId,!0);if(0<t.length)for(endStationId in"SELL"==orderTypeStart&&"BUY"==orderTypeEnd||(t="BUY"==orderTypeStart?[t[0]]:[t[t.length-1]]),this.sellOrders)if((!(999999999<endStationId)||this.includeCitadels)&&endStationId!==startStationId){var s={};s.region=this.endLocations.id,s.station=endStationId;var a=this.sellOrders[endStationId];if(a&&a[itemId]){var o=getMarketData(a[itemId],s.station,BUY_ORDER,itemId,!0);if(0<o.length){"SELL"==orderTypeStart&&"BUY"==orderTypeEnd||(o="BUY"==orderTypeStart?[o[0]]:[o[o.length-1]]);var i={};i.itemId=itemId,i.buyPrice=t,i.sellPrice=o,i.start=e,i.end=s,this.regionRoutes.push(i)}}}}}this.executeRoutes()}},Region.prototype.executeRoutes=function(){var s=this,a=0,o=this.regionRoutes.length,i=100-totalProgress,r=totalProgress;this.routesExecutor=setInterval(function(){0==s.regionRoutes.length&&(s.completed=!0,totalProgress=100,clearInterval(s.routesExecutor),rowAdded&&$(".loading").hide(),$(".tableLoadingIcon").hide(),$("#buyingFooter").append('<div id="refresh-timer"></div>'),s.asyncRefresh());for(var e=0;e<s.regionRoutes.length&&e<1e3;e++){var t=s.regionRoutes.splice(0,1)[0];s.getItemInfo(t.itemId,t.buyPrice,t.sellPrice,t.start,t.end),a+=1}totalProgress=r+i*(a/o),$(".loading").html("Adding orders to table: "+totalProgress.toFixed(2)+"% complete"),$(".loadingContent").text(totalProgress.toFixed(2)+"%")},1e3)},Region.prototype.clear=function(){this.startLocation=null,this.endLocations=null,this.buyOrders={},this.buyOrders.completePages=[],this.buyOrders.complete=!1,this.buyOrders.pageBookend=PAGE_MULTIPLE,this.sellOrders={},this.sellOrders.completePages=[],this.sellOrders.complete=!1,this.sellOrders.pageBookend=PAGE_MULTIPLE,this.regionRoutes=[],this.secondsToRefresh=120,clearInterval(this.asyncRefresher),clearInterval(this.asyncProgressUpdate),clearInterval(this.routesExecutor),this.completed=!1},Region.prototype.asyncRefresh=function(){var e=this;this.asyncRefresher=setInterval(function(){e.secondsToRefresh<=0?(clearInterval(e.asyncRefresher),$("#refresh-timer").remove(),$("#buyingFooter").append('<div id="refresh-button"><input type="button" class="btn btn-default" onclick="refresh()" value="Refresh Table with Last Query"/></div>')):(rowAdded?$(".loading").hide():$(".loading").text("No trades found for your filters."),$("#refresh-timer").html("<p>Refresh allowed in: "+e.secondsToRefresh+" seconds."),e.secondsToRefresh--)},1e3)},Region.prototype.getItemInfo=function(e,t,s,a,o){for(var i=[],r=0;r<t.length;r++)for(var n=0;n<s.length;n++){var l=this.calculateRow(e,t[r][0],t[r][1],s[n][0],s[n][1],a,o);0<l.length&&i.push(l)}0<i.length&&(i=i.sort(bestRowComparator),this.getItemWeight(e,this.createRowObject(i[0])))},Region.prototype.calculateRow=function(e,t,s,a,o,i,r){if(t<a&&0<a){var n,l,d,c=a-t;o<=s?(n=(d=o)*c,l=t*o):(n=(d=s)*c,l=t*s);var u=(a-t)/t;return n>=threshold_profit&&(100*u.toFixed(3)).toFixed(1)>=threshold_roi&&l<=threshold_cost?[e,i,t,d,l,r,n,u,a,c]:[]}return[]},Region.prototype.getItemWeight=function(a,o){if(itemCache[a]){var e=itemCache[a].name,t=itemCache[a].weight;o.itemName=e,o.itemWeight=t,this.addRow(o)}else{var i=this,s=getWeightEndpointBuilder(a);$.ajax({type:"get",url:s,dataType:"json",async:!0,cache:!1,contentType:"application/json",success:function(e){var t=e.name,s=e.packaged_volume;itemCache[a]={},itemCache[a].name=t,itemCache[a].weight=s,o.itemName=t,o.itemWeight=s,i.addRow(o)},error:function(e){404!=e.status&&"parsererror"!==e.statusText&&i.getItemWeight(a,o)}})}},Region.prototype.createRowObject=function(e){var t={};return t.itemId=e[0],t.buyFromStation=e[1],t.buyPrice=e[2],t.quantity=e[3],t.buyCost=e[4],t.sellToStation=e[5],t.totalProfit=e[6],t.roi=e[7],t.sellPrice=e[8],t.perItemProfit=e[9],t},Region.prototype.updateEndWithCitadel=function(o){var i=o.sellToStation.station,r=this;if(i<999999999)if(citadelCache[i]){var e=citadelCache[i].name,t=citadelCache[i].system;o.sellToStation.name=e,o.sellToStation.system=t,this.getStartSystemSecurity(o)}else $.ajax({type:"get",url:"https://esi.evetech.net/latest/universe/stations/"+o.sellToStation.station+"/?datasource=tranquility",dataType:"json",contentType:"application/json",async:!0,success:function(e){var t=e.name,s=e.system_id,a={};a.name=t,a.system=s,citadelCache[i]=a,o.sellToStation.name=t,o.sellToStation.system=s,r.getStartSystemSecurity(o)}});else if(this.includeCitadels)if(citadelCache[i]){e=citadelCache[i].name,t=citadelCache[i].system;o.sellToStation.name="<strong><em>"+e+"*</em></strong>",o.sellToStation.system=t,this.getStartSystemSecurity(o)}else $.ajax({type:"get",url:"https://stop.hammerti.me.uk/api/citadel/"+i,dataType:"json",contentType:"application/json",async:!0,success:function(e){var t=(e=e[i]).name,s=e.systemId,a={};a.name=t,a.system=s,citadelCache[i]=a,o.sellToStation.name="<strong><em>"+t+"*</em></strong>",o.sellToStation.system=s,r.getStartSystemSecurity(o)}})},Region.prototype.updateStartWithCitdael=function(o){var i=o.buyFromStation.station,r=this;if(i<999999999)if(citadelCache[i]){var e=citadelCache[i].name,t=citadelCache[i].system;o.buyFromStation.name=e,o.buyFromStation.system=t,this.updateEndWithCitadel(o)}else $.ajax({type:"get",url:"https://esi.evetech.net/latest/universe/stations/"+o.buyFromStation.station+"/?datasource=tranquility",dataType:"json",contentType:"application/json",async:!0,success:function(e){var t=e.name,s=e.system_id,a={};a.name=t,a.system=s,citadelCache[i]=a,o.buyFromStation.name=t,o.buyFromStation.system=s,r.updateEndWithCitadel(o)}});else if(this.includeCitadels)if(citadelCache[i]){e=citadelCache[i].name,t=citadelCache[i].system;o.buyFromStation.name="<strong><em>"+e+"*</em></strong>",o.buyFromStation.system=t,this.updateEndWithCitadel(o)}else $.ajax({type:"get",url:"https://stop.hammerti.me.uk/api/citadel/"+i,dataType:"json",contentType:"application/json",async:!0,success:function(e){var t=(e=e[i]).name,s=e.systemId,a={};a.name=t,a.system=s,citadelCache[i]=a,o.buyFromStation.name="<strong><em>"+t+"*</em></strong>",o.buyFromStation.system=s,r.updateEndWithCitadel(o)}})},Region.prototype.addRow=function(e){e.itemWeight*e.quantity>threshold_weight||isSpamItem(e.itemName)||(createDataTable(),this.updateStartWithCitdael(e))},Region.prototype.getSecurityCode=function(e){return.5<=e?"high_sec":0<e&&("NULL"==this.security||"LOW"==this.security)?"low_sec":e<=0&&"NULL"==this.security?"null_sec":-1},Region.prototype.getEndSystemSecurity=function(a){var o=a.sellToStation.system,i=this;if(systemSecurity[o]){var e=systemSecurity[o],t=this.getSecurityCode(e);if(-1==t)return;a.sellToStation.name="<span class='"+t+"'>"+a.sellToStation.name+"</span>",this.getRouteLength(a)}else $.ajax({type:"get",url:"https://esi.evetech.net/latest/universe/systems/"+o+"/?datasource=tranquility&language=en-us",dataType:"json",contentType:"application/json",async:!0,success:function(e){systemSecurity[o]=e.security_status;var t=systemSecurity[o],s=i.getSecurityCode(t);-1!=s&&(a.sellToStation.name="<span class='"+s+"'>"+a.sellToStation.name+"</span>",i.getRouteLength(a))}})},Region.prototype.getStartSystemSecurity=function(a){var o=a.buyFromStation.system,i=this;if(systemSecurity[o]){var e=systemSecurity[o],t=this.getSecurityCode(e);if(-1==t)return;a.buyFromStation.name="<span class='"+t+"'>"+a.buyFromStation.name+"</span>",this.getEndSystemSecurity(a)}else $.ajax({type:"get",url:"https://esi.evetech.net/latest/universe/systems/"+o+"/?datasource=tranquility&language=en-us",dataType:"json",contentType:"application/json",async:!0,success:function(e){systemSecurity[o]=e.security_status;var t=systemSecurity[o],s=i.getSecurityCode(t);-1!=s&&(a.buyFromStation.name="<span class='"+s+"'>"+a.buyFromStation.name+"</span>",i.getEndSystemSecurity(a))}})},Region.prototype.getRouteLength=function(s){var e=s.buyFromStation.system,t=s.sellToStation.system,a=e+"-"+t,o=this;if(routeCache[a]){var i=routeCache[a];s.routeLength=i,this.updateDatatable(s)}else $.ajax({type:"get",url:"https://esi.evetech.net/latest/route/"+e+"/"+t+"/?datasource=tranquility&flag="+o.safety,dataType:"json",contentType:"application/json",async:!0,success:function(e){var t=e.length;routeCache[a]=t,s.routeLength=t,o.updateDatatable(s)}})},Region.prototype.updateDatatable=function(e){var t=e.sellToStation.station+e.buyFromStation.station+e.itemId+"_investigate",s=e.itemWeight*e.quantity,a=['<span id="'+t+'"data-itemId="'+e.itemId+'"data-itemName="'+e.itemName+'"data-fromStationId="'+e.buyFromStation.station+'"data-sellStationId="'+e.sellToStation.station+'"><i class="fa fa-search-plus"></i></span>',e.itemName,e.buyFromStation.name,numberWithCommas(e.quantity),numberWithCommas(e.buyPrice.toFixed(2)),numberWithCommas(e.buyCost.toFixed(2)),e.sellToStation.name,numberWithCommas(e.sellPrice.toFixed(2)),e.routeLength,numberWithCommas((e.totalProfit/e.routeLength).toFixed(2)),numberWithCommas(e.totalProfit.toFixed(2)),(100*e.roi.toFixed(3)).toFixed(1)+"%",numberWithCommas(s.toFixed(2))],o=$("#dataTable").dataTable().fnAddData(a);$("#dataTable").dataTable().fnGetNodes(o),$("#"+t).on("click",function(){var e=parseInt(this.dataset.itemid),t=this.dataset.itemname,s=parseInt(this.dataset.fromstationid),a={};a.name=stationIdToName[s],a.station=s;var o={};o.name=stationIdToName[this.dataset.sellstationid],o.station=parseInt(this.dataset.sellstationid),open_popup(e,t,a,o)}),rowAdded=!0};