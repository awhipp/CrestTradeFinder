var routes=[];function Region(a,b){this.startLocation=a;this.endLocations=b;this.buyOrders={};this.buyOrders.completePages=[];this.buyOrders.complete=false;this.buyOrders.pageBookend=PAGE_MULTIPLE;this.sellOrders={};this.sellOrders.completePages=[];this.sellOrders.complete=false;this.sellOrders.pageBookend=PAGE_MULTIPLE;this.totalProgress=0;this.regionRoutes=[];this.secondsToRefresh=60;this.asyncRefresher=null;this.asyncProgressUpdate=null;this.routesExecutor=null;this.completed=false;routes.push(this)}Region.prototype.className=function(){return"Route"};Region.prototype.startRoute=function(){var a;var b=parseInt(this.startLocation.id);for(a=1;a<=PAGE_MULTIPLE;a++){this.getSellOrders(b,a,this.buyOrders)}b=parseInt(this.endLocations.id);for(a=1;a<=PAGE_MULTIPLE;a++){this.getBuyOrders(b,a,this.sellOrders)}$("#selection").hide()};Region.prototype.recalculateProgress=function(){var a=this.getNumberOfCompletePages(this.buyOrders);a+=this.getNumberOfCompletePages(this.sellOrders);return a<=0?1:35*Math.log10(a)};Region.prototype.getBuyOrders=function(b,a,c){this.getOrders(b,a,c,BUY_ORDER)};Region.prototype.getSellOrders=function(b,a,c){this.getOrders(b,a,c,SELL_ORDER)};Region.prototype.getOrders=function(e,d,f,a){var b=marketEndpointBuilder(e,d,a);var c=this;if(!f.completePages[d]){$.ajax({type:"get",url:b,dataType:"json",contentType:"application/json",async:true,success:function(l){incrementProgress(f,d);if(l.length===0&&!f.complete){f.complete=true;console.log("Completed "+e+" order fetch at "+d)}else{for(var h=0;h<l.length;h++){var k=l[h]["location_id"];var m=l[h]["type_id"];if(!f[k]){f[k]={}}if(!f[k][m]){f[k][m]=[]}f[k][m].push(l[h])}if(!f.complete&&c.getNumberOfCompletePages(f)===f.pageBookend){var j=d+1;f.pageBookend=(f.pageBookend+PAGE_MULTIPLE);for(var g=f.pageBookend;j<=g;j++){c.getOrders(e,j,f,a)}}else{c.executeOrders()}}},error:function(i,k,j){displayError();incrementProgress(f,d);if(!f.complete&&c.getNumberOfCompletePages(f)===f.pageBookend){var h=d+1;f.pageBookend=(f.pageBookend+PAGE_MULTIPLE);for(var g=f.pageBookend;h<=g;h++){c.getOrders(e,h,f,a)}}}})}};Region.prototype.getNumberOfCompletePages=function(a){var c=0;for(var b=0;b<a.completePages.length;b++){if(a.completePages[b]){c++}}return c};Region.prototype.checkOrdersComplete=function(){var a=(this.getNumberOfCompletePages(this.buyOrders)===this.buyOrders.pageBookend);var b=this.buyOrders.complete;a=a&&(this.getNumberOfCompletePages(this.sellOrders)===this.sellOrders.pageBookend);b=b&&this.sellOrders.complete;return(a&&b)};Region.regionRoutes=[];Region.prototype.executeOrders=function(){if(this.checkOrdersComplete()){hideError();for(startStationId in this.buyOrders){var f={};f.name=stationIdToName[startStationId];f.region=this.startLocation.id;f.station=startStationId;for(itemId in this.buyOrders[startStationId]){if(itemId!=="completePages"&&itemId!=="complete"&&itemId!=="pageBookend"){var a=getMarketData(this.buyOrders[startStationId][itemId],f.station,SELL_ORDER,itemId,true);if(a.length>0){for(endStationId in this.sellOrders){if(endStationId<999999999&&endStationId!==startStationId){var c={};c.name=stationIdToName[endStationId];c.region=this.endLocations.id;c.station=endStationId;var b=this.sellOrders[endStationId];if(b&&b[itemId]){var e=getMarketData(b[itemId],c.station,BUY_ORDER,itemId,true);if(e.length>0){var d={};d.itemId=itemId;d.buyPrice=a;d.sellPrice=e;d.start=f;d.end=c;this.regionRoutes.push(d)}}}}}}}}this.executeRoutes()}};Region.prototype.executeRoutes=function(){var d=this;var c=0;var b=this.regionRoutes.length;var e=100-totalProgress;var a=totalProgress;this.routesExecutor=setInterval(function(){if(d.regionRoutes.length==0){d.completed=true;totalProgress=100;clearInterval(d.routesExecutor);if(rowAdded){$(".loading").hide()}$(".tableLoadingIcon").hide();$("#buyingFooter").append('<div id="refresh-timer"></div>');d.asyncRefresh()}for(var g=0;g<d.regionRoutes.length&&g<1000;g++){var f=d.regionRoutes.splice(0,1)[0];d.getItemInfo(f.itemId,f.buyPrice,f.sellPrice,f.start,f.end);c+=1}totalProgress=a+(e*(c/b));$(".loading").html("Adding orders to table: "+totalProgress.toFixed(2)+"% complete");$(".loadingContent").text((totalProgress).toFixed(2)+"%")},1000)};Region.prototype.clear=function(){this.startLocation=null;this.endLocations=null;this.buyOrders={};this.buyOrders.completePages=[];this.buyOrders.complete=false;this.buyOrders.pageBookend=PAGE_MULTIPLE;this.sellOrders={};this.sellOrders.completePages=[];this.sellOrders.complete=false;this.sellOrders.pageBookend=PAGE_MULTIPLE;this.regionRoutes=[];this.secondsToRefresh=120;clearInterval(this.asyncRefresher);clearInterval(this.asyncProgressUpdate);clearInterval(this.routesExecutor);this.completed=false};Region.prototype.asyncRefresh=function(){var a=this;this.asyncRefresher=setInterval(function(){if(a.secondsToRefresh<=0){clearInterval(a.asyncRefresher);$("#refresh-timer").remove();$("#buyingFooter").append('<div id="refresh-button"><input type="button" class="btn btn-default" onclick="refresh()" value="Refresh Table with Last Query"/></div>')}else{if(rowAdded){$(".loading").hide()}else{$(".loading").text("No trades found for your filters.")}$("#refresh-timer").html("<p>Refresh allowed in: "+a.secondsToRefresh+" seconds.");a.secondsToRefresh--}},1000)};Region.prototype.getItemInfo=function(g,b,f,a,c){var k=[];for(var e=0;e<b.length;e++){for(var d=0;d<f.length;d++){var h=this.calculateRow(g,b[e][0],b[e][1],f[d][0],f[d][1],a,c);if(h.length>0){k.push(h)}}}if(k.length>0){k=k.sort(bestRowComparator);this.getItemWeight(g,this.createRowObject(k[0]))}};Region.prototype.calculateRow=function(k,d,h,i,j,b,e){if(d<i&&i>0){var g=i-d;var a;var c;var f;if(h>=j){f=j;a=j*g;c=d*j}else{f=h;a=h*g;c=d*h}var l=(i-d)/d;if(a>=threshold_profit&&(l.toFixed(3)*100).toFixed(1)>=threshold_roi&&c<=threshold_cost){return[k,b,d,f,c,e,a,l,i,g]}else{return[]}}return[]};Region.prototype.getItemWeight=function(f,e){if(itemCache[f]){var b=itemCache[f].name;var d=itemCache[f].weight;e.itemName=b;e.itemWeight=d;this.addRow(e)}else{var c=this;var a=getWeightEndpointBuilder(f);$.ajax({type:"get",url:a,dataType:"json",async:true,cache:false,contentType:"application/json",success:function(i){var g=i.name;var h=i.packaged_volume;itemCache[f]={};itemCache[f].name=g;itemCache[f].weight=h;e.itemName=g;e.itemWeight=h;c.addRow(e)},error:function(h,g){if(h.status!=404&&h.statusText!=="parsererror"){c.getItemWeight(f,e)}}})}};Region.prototype.createRowObject=function(b){var a={};a.itemId=b[0];a.buyFromStation=b[1];a.buyPrice=b[2];a.quantity=b[3];a.buyCost=b[4];a.sellToStation=b[5];a.totalProfit=b[6];a.roi=b[7];a.sellPrice=b[8];a.perItemProfit=b[9];return a};Region.prototype.addRow=function(c){var b=c.itemWeight*c.quantity;if(b>threshold_weight){return}if(isSpamItem(c.itemName)){return}createDataTable();var e=c.sellToStation.station+c.buyFromStation.station+c.itemId+"_investigate";var a=['<span id="'+e+'"data-itemId="'+c.itemId+'"data-itemName="'+c.itemName+'"data-fromStationId="'+c.buyFromStation.station+'"data-sellStationId="'+c.sellToStation.station+'"><i class="fa fa-search-plus"></i></span>',c.itemName,c.buyFromStation.name,numberWithCommas(c.quantity),numberWithCommas(c.buyPrice.toFixed(2)),numberWithCommas(c.buyCost.toFixed(2)),c.sellToStation.name,numberWithCommas(c.sellPrice.toFixed(2)),numberWithCommas(c.totalProfit.toFixed(2)),numberWithCommas(c.perItemProfit.toFixed(2)),(c.roi.toFixed(3)*100).toFixed(1)+"%",numberWithCommas(b.toFixed(2))];var d=$("#dataTable").dataTable().fnAddData(a);$("#dataTable").dataTable().fnGetNodes(d);$("#"+e).on("click",function(){var g=parseInt(this.dataset.itemid);var j=this.dataset.itemname;var h=parseInt(this.dataset.fromstationid);var i={};i.name=stationIdToName[h];i.station=h;var f={};f.name=stationIdToName[this.dataset.sellstationid];f.station=parseInt(this.dataset.sellstationid);open_popup(g,j,i,f)});rowAdded=true};Region.prototype.createTable=function(){tableCreated=true;$("#show-hide").show();$("#dataTable").show();$(".data_options").append($("#dataTable_filter"));$(".data_options").append($(".dt-buttons"));$(".dt-button").addClass("btn");$(".dt-button").addClass("btn-default");$(".deal_note").hide();$("#core input").css("display","block");$("#core a").css("display","inline-block");$("#core").show()};