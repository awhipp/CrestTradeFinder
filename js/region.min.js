var routes=[];function Region(a,b){this.startLocation=a;this.endLocations=b;this.buyOrders={};this.buyOrders.completePages=[];this.buyOrders.complete=false;this.buyOrders.pageBookend=PAGE_MULTIPLE;this.sellOrders={};this.sellOrders.completePages=[];this.sellOrders.complete=false;this.sellOrders.pageBookend=PAGE_MULTIPLE;this.totalProgress=0;this.itemIds=[];this.secondsToRefresh=60;this.asyncRefresher=null;this.asyncProgressUpdate=null;this.completed=false;routes.push(this)}Region.prototype.className=function(){return"Route"};Region.prototype.startRoute=function(){var a;var b=parseInt(this.startLocation.id);for(a=1;a<=PAGE_MULTIPLE;a++){this.getSellOrders(b,a,this.buyOrders)}b=parseInt(this.endLocations.id);for(a=1;a<=PAGE_MULTIPLE;a++){this.getBuyOrders(b,a,this.sellOrders)}$("#selection").hide()};Region.prototype.marketEndpointBuilder=function(d,c,a){var b=ESI_ENDPOINT+"/latest/markets/"+d+"/orders/?datasource=tranquility&page="+c+"&order_type="+a+"&language=en-us&iteration="+iteration;return b.replace(/\s/g,"")};Region.prototype.getWeightEndpointBuilder=function(b){var a=ESI_ENDPOINT+"/latest/universe/types/"+b+"/?datasource=tranquility&language=en-us&iteration="+iteration;return a.replace(/\s/g,"")};Region.prototype.recalculateProgress=function(){var a=this.getNumberOfCompletePages(this.buyOrders);a+=this.getNumberOfCompletePages(this.sellOrders);return a<=0?1:35*Math.log10(a)};Region.prototype.incrementProgress=function(b,a){getTotalProgress();b.completePages[a]=true};Region.prototype.getBuyOrders=function(b,a,c){this.getOrders(b,a,c,BUY_ORDER)};Region.prototype.getSellOrders=function(b,a,c){this.getOrders(b,a,c,SELL_ORDER)};Region.prototype.getOrders=function(e,d,f,a){var b=this.marketEndpointBuilder(e,d,a);var c=this;if(!f.completePages[d]){$.ajax({type:"get",url:b,dataType:"json",contentType:"application/json",async:true,success:function(l){c.incrementProgress(f,d);if(l.length===0&&!f.complete){f.complete=true;console.log("Completed "+e+" order fetch at "+d)}else{for(var h=0;h<l.length;h++){var k=l[h]["location_id"];var m=l[h]["type_id"];if(!f[k]){f[k]={}}if(!f[k][m]){f[k][m]=[]}f[k][m].push(l[h])}if(!f.complete&&c.getNumberOfCompletePages(f)===f.pageBookend){var j=d+1;f.pageBookend=(f.pageBookend+PAGE_MULTIPLE);for(var g=f.pageBookend;j<=g;j++){c.getOrders(e,j,f,a)}}else{c.executeOrders()}}},error:function(i,k,j){displayError();c.incrementProgress(f,d);if(!f.complete&&c.getNumberOfCompletePages(f)===f.pageBookend){var h=d+1;f.pageBookend=(f.pageBookend+PAGE_MULTIPLE);for(var g=f.pageBookend;h<=g;h++){c.getOrders(e,h,f,a)}}}})}};Region.prototype.getNumberOfCompletePages=function(a){var c=0;for(var b=0;b<a.completePages.length;b++){if(a.completePages[b]){c++}}return c};Region.prototype.checkOrdersComplete=function(){var a=(this.getNumberOfCompletePages(this.buyOrders)===this.buyOrders.pageBookend);var b=this.buyOrders.complete;a=a&&(this.getNumberOfCompletePages(this.sellOrders)===this.sellOrders.pageBookend);b=b&&this.sellOrders.complete;return(a&&b)};Region.prototype.executeOrders=function(){if(this.checkOrdersComplete()){hideError();console.log("here")}};Region.prototype.clear=function(){this.startLocation=null;this.endLocations=null;this.buyOrders={};this.buyOrders.completePages=[];this.buyOrders.complete=false;this.buyOrders.pageBookend=PAGE_MULTIPLE;this.sellOrders={};this.itemIds=[];this.secondsToRefresh=60;clearInterval(this.asyncRefresher);clearInterval(this.asyncProgressUpdate)};Region.prototype.asyncRefresh=function(){var a=this;this.asyncRefresher=setInterval(function(){if(a.secondsToRefresh<=0){clearInterval(a.asyncRefresher);$("#refresh-timer").remove();$("#buyingFooter").append('<div id="refresh-button"><input type="button" class="btn btn-default" onclick="refresh()" value="Refresh Table with Last Query"/></div>')}else{$("#refresh-timer").html("<br><p>Refresh allowed in: "+a.secondsToRefresh+" seconds.");a.secondsToRefresh--}},1000)};Region.prototype.asyncProgress=function(){var a=this;this.asyncProgressUpdate=setInterval(function(){getTotalProgress();if(totalProgress==100){clearInterval(a.asyncProgressUpdate);if(rowAdded){$(".loading").hide()}$("#buyingFooter").append('<div id="refresh-timer"></div>');if(!createdRefresher){createdRefresher=true;a.asyncRefresh()}}},2500)};Region.prototype.calculate=function(){this.asyncProgress();while(this.itemIds.length!=0){executingCount++;var a=this.itemIds.splice(0,1)[0];if(this.itemIds.length==0){this.completed=true}this.calculateNext(a)}};Region.prototype.calculateNext=function(h){var c=getMarketData(this.buyOrders[h],this.startLocation.station,SELL_ORDER,h,true);if(c.length>0){var d=false;var a=0;for(var e=0;e<this.endLocations.length;e++){if(this.endLocations[e].station!==this.startLocation.station){var f=this.sellOrders[a];var j=this.endLocations[e];if(f[h]){var g=getMarketData(f[h],j.station,BUY_ORDER,h,true);if(g.length>0){var b={};b.region=j.region;b.station=j.station;d=true;this.getItemInfo(h,c,g,b)}}a+=1}}if(!d){executingCount--}}else{executingCount--}};Region.prototype.getItemInfo=function(h,a,e,g){var d=[];for(var c=0;c<a.length;c++){for(var b=0;b<e.length;b++){var f=this.calculateRow(h,a[c][0],a[c][1],e[b][0],e[b][1],g);if(f.length>0){d.push(f)}}}if(d.length>0){d=d.sort(bestRowComparator);this.getItemWeight(h,this.createRowObject(d[0]))}else{executingCount--}};Region.prototype.calculateRow=function(j,d,g,h,i,c){if(d<h&&h>0){var f=h-d;var a;var b;var e;if(g>=i){e=i;a=i*f;b=d*i}else{e=g;a=g*f;b=d*g}var k=(h-d)/d;if(a>=threshold_profit&&(k.toFixed(3)*100).toFixed(1)>=threshold_roi&&b<=threshold_cost){return[j,d,e,b,c,a,k,h,f]}else{return[]}}return[]};Region.prototype.getItemWeight=function(f,e){if(itemCache[f]){var b=itemCache[f].name;var d=itemCache[f].weight;e.itemName=b;e.itemWeight=d;this.addRow(e);executingCount--}else{var c=this;var a=this.getWeightEndpointBuilder(f);$.ajax({type:"get",url:a,dataType:"json",async:true,cache:false,contentType:"application/json",success:function(i){executingCount--;var g=i.name;var h=i.packaged_volume;itemCache[f]={};itemCache[f].name=g;itemCache[f].weight=h;e.itemName=g;e.itemWeight=h;c.addRow(e)},error:function(h,g){if(h.status!=404&&h.statusText!=="parsererror"){c.getItemWeight(f,e)}else{executingCount--}}})}};Region.prototype.createRowObject=function(b){var a={};a.itemId=b[0];a.buyPrice=b[1];a.quantity=b[2];a.buyCost=b[3];a.sellToStation=b[4];a.totalProfit=b[5];a.roi=b[6];a.sellPrice=b[7];a.perItemProfit=b[8];return a};Region.prototype.addRow=function(c){var b=c.itemWeight*c.quantity;if(b>threshold_weight){return}if(isSpamItem(c.itemName)){return}if(!tableCreated){this.createTable()}var e=c.sellToStation.station+this.startLocation.station+c.itemId+"_investigate";var a=['<span id="'+e+'"data-itemId="'+c.itemId+'"data-itemName="'+c.itemName+'"data-routeId="'+this.routeId+'"data-sellStationId="'+c.sellToStation.station+'"><i class="fa fa-search-plus"></i></span>',c.itemName,this.startLocation.name,numberWithCommas(c.quantity),numberWithCommas(c.buyPrice.toFixed(2)),numberWithCommas(c.buyCost.toFixed(2)),getStationName(c.sellToStation.station),numberWithCommas(c.sellPrice.toFixed(2)),numberWithCommas(c.totalProfit.toFixed(2)),numberWithCommas(c.perItemProfit.toFixed(2)),(c.roi.toFixed(3)*100).toFixed(1)+"%",numberWithCommas(b.toFixed(2))];var d=$("#dataTable").dataTable().fnAddData(a);$("#dataTable").dataTable().fnGetNodes(d);$("#"+e).on("click",function(){var g=parseInt(this.dataset.itemid);var i=this.dataset.itemname;var h=routes[parseInt(this.dataset.routeid)].startLocation;var f=parseInt(this.dataset.sellstationid);open_popup(g,i,h,f)});rowAdded=true};Region.prototype.createTable=function(){tableCreated=true;$("#show-hide").show();$("#dataTable").show();$(".data_options").append($("#dataTable_filter"));$(".data_options").append($(".dt-buttons"));$(".dt-button").addClass("btn");$(".dt-button").addClass("btn-default");$(".deal_note").hide();$("#core input").css("display","block");$("#core a").css("display","inline-block");$("#core").show()};