var dt,station_buy,buy_orders,sell_orders,increment,total_progress,SECOND_DELAY=0,PAGES=40,stations=[],created=!1,isStationBuying=!1;function getData(e,t,o,s){var r,a=[];if("string"==typeof e?r=[e]:null!=e&&(r=getPrice(e,t,o,s)),r)for(var i=0;i<r.length;i++)r[i][0]>0&&a.push(r[i]);return a}function beginStation(e){beginRoute(e,e)}function beginRoute(e,t){e==t&&(isStationBuying=!0,t=[t]),station_buy=e,(buy_orders={}).complete=!1,buy_orders.region=station_buy[0],buy_orders.station=station_buy[1],buy_orders.complete_pages=0,increment=100/(t.length+1)/PAGES,total_progress=0;for(var o=1;o<=PAGES;o++)getOrders(o,station_buy[0],station_buy[1],buy_orders);stations=t,sell_orders=[];for(var s=0;s<t.length;s++){sell_orders[s]={},sell_orders[s].complete=!1;var r=t[s][0],a=t[s][1];sell_orders[s].region=r,sell_orders[s].station=a,sell_orders[s].complete_pages=0;for(o=1;o<=PAGES;o++)getOrders(o,r,a,sell_orders[s])}$("#selection").hide()}var itemids=[],executingGet=!1,numberOfRequests=0;function next(e){var t;(t=getData(buy_orders[e],buy_orders.station,"sell",e)).length>0?executeRowCompute(e,t):0!=itemids.length||executingGet||created||$(".loading").text("No trades found for your filters.")}var shown=!1;function displayError(){shown||($("#connectEVE").slideToggle(!0),shown=!0)}function hideError(){shown&&($("#connectEVE").slideToggle(),shown=!1)}var errorPages={};function getOrders(e,t,o,s){t=parseInt(t),o=parseInt(o);var r="https://esi.tech.ccp.is/latest/markets/"+t+"/orders/?datasource=tranquility&page="+e;$.ajax({type:"get",url:r,dataType:"json",contentType:"application/json",success:function(e){if(s.complete_pages+=1,total_progress+=increment,$(".loading").html("<b>Getting orders: "+total_progress.toFixed(2)+"% complete</b>"),s.complete_pages==PAGES)executeOrders();else for(var t=0;t<e.length;t++)if(e[t].location_id===o){var r=e[t].type_id;s[r]||(s[r]=[]),s[r].push(e[t])}},error:function(){displayError(),errorPages[""+e]?errorPages[""+e]+=1:errorPages[""+e]=1,errorPages[""+e]>3?(s.complete_pages+=1,total_progress+=increment,$(".loading").html("<b>Getting orders: "+total_progress.toFixed(2)+"% complete</b>"),s.complete_pages==PAGES&&executeOrders()):getOrders(e,t,o,s)}})}function executeOrders(){for(var e=!0,t=0;t<sell_orders.length;t++)sell_orders[t].complete_pages!==PAGES?e=!1:sell_orders[t].complete=!0;if(buy_orders.complete_pages===PAGES&&(buy_orders.complete=!0),!0===buy_orders.complete&&e){for(o in total_progress=100,$(".loading").text("Getting orders: "+total_progress.toFixed(2)+"% complete"),buy_orders)itemids.push(o);for(;0!=itemids.length;){var o=itemids.splice(0,1)[0];next(o)}hideError()}else;}function executeRowCompute(e,t){if("complete"!==e||"station"!==e||"region"!==e||"complete_pages"!=e)for(var o=0;o<sell_orders.length;o++)if(void 0!==sell_orders[o][e]){var s=getData(sell_orders[o][e],sell_orders[o].station,"buy",e);if(s.length>0)getItemInfo(e,t,s,[sell_orders[o].region,sell_orders[o].station])}}function getItemInfo(e,t,o,s){for(var r=[],a=o[0][0],i=t[0][0],n=0;n<t.length;n++)for(var l=0;l<o.length;l++){if(isStationBuying)o[l][0]>i&&(i=o[l][0]),t[n][0]<a&&(a=t[n][0]);else(d=calculateRow(e,t[n][0],t[n][1],o[l][0],o[l][1],s)).length>0&&r.push(d)}if(isStationBuying){var d={},u=((o=i)-(t=a))/o;100*u>=threshold_margin_lower&&100*u<=threshold_margin_upper&&o-t>1e3&&(d.buyPrice=t,d.sellPrice=o,r.push(d),r.length>0&&getItemVolume(e,r=r.sort(rowComparator)))}else r.length>0&&getItemWeight(e,r=r.sort(rowComparator))}var filteringInterval,count=0;function updateFilterCount(){filteringInterval=setInterval(function(){count++;for(var e="",t=0;t<count%5;t++)e+=".";$("#filtering-data").html("Filtering Data. Please wait"+e),0==executingGet&&(clearInterval(filteringInterval),$("#filtering-data").remove())},1e3)}var filtered=!1;function getItemVolume(e,t){executingGet=!0,filtered||(filtered=!0,$("#buyingFooter").append("<div id='filtering-data'>Filtering Data. Please wait.</div>"),updateFilterCount()),$.ajax({type:"get",url:"https://esi.tech.ccp.is/latest/markets/"+stations[0][0]+"/history/?datasource=tranquility&type_id="+e+"&language=en-us",dataType:"json",async:!0,contentType:"application/json",success:function(o){var s=t[0];s.volume=o[o.length-1].volume,s.volume>=volume_threshold&&numberOfRequests<1e3&&(numberOfRequests++,getItemWeight(e,t))},error:function(o,s){404!=o.status&&(console.log(o),getItemVolume(e,t))}})}var itemWeightCache={};function getItemWeight(e,t){if(itemWeightCache[e]){var o=itemWeightCache[e][0],s=itemWeightCache[e][1],r=t[0];isStationBuying?addMarginRow(e,o,r.buyPrice,r.sellPrice):addRow(r[0],o,r[1],r[2],r[3],r[4],r[5],r[6],r[7],r[8],r[9],s)}else executingGet=!0,$.ajax({type:"get",url:"https://esi.tech.ccp.is/latest/universe/types/"+e+"/?datasource=tranquility&language=en-us",dataType:"json",async:!0,contentType:"application/json",success:function(o){executingGet=!1;var s=o.name,r=o.volume;itemWeightCache[e]=[],itemWeightCache[e][0]=s,itemWeightCache[e][1]=r;var a=t[0];isStationBuying?addMarginRow(e,s,a.buyPrice,a.sellPrice,a.volume):addRow(a[0],s,a[1],a[2],a[3],a[4],a[5],a[6],a[7],a[8],a[9],r)},error:function(o,s){404!=o.status&&(console.log(o),getItemWeight(e,t))}})}function rowComparator(e,t){return e[5]<t[5]?1:e[5]>t[5]?-1:0}function calculateRow(e,t,o,s,r,a){if(t<s&&s>0){var i,n,l,d=s-t;o>=r?(l=numberWithCommas(o.toFixed())+"-<span class='selected_volume'>"+numberWithCommas(r.toFixed())+"</span>",i=r*d,n=t*r):(l="<span class='selected_volume'>"+numberWithCommas(o.toFixed())+"</span>-"+numberWithCommas(r.toFixed()),i=o*d,n=t*o);var u=getLocation(a[1]),c=(s-t)/t;return i>=threshold_profit&&(100*c.toFixed(3)).toFixed(1)>=threshold_roi&&n<=threshold_cost?[e,t,l,n,u,i,c,s,d,a,void 0]:[]}return[]}function getLocation(e){return isCustom?getCustomEnd(e):e===JITA[1]?"Jita":e===AMARR[1]?"Amarr":e===DODIXIE[1]?"Dodixie":e===RENS[1]?"Rens":e===HEK[1]?"Hek":getCustomEnd(e)}function getCustomEnd(e){for(var t=0;t<stations.length;t++)if(e===stations[t][1])return customEnd[t];return"nil"}function addRow(e,t,o,s,r,a,i,n,l,d,u,c){for(var p=a+"";-1!=a.indexOf("(");)a=a.replace("(","");for(;-1!=a.indexOf(")");)a=a.replace(")","");var m=e+"_"+a+"_"+u[1];if(c){for(var h,f=s.split("-")[0],g=s.split("-")[1],b=(h=f.indexOf("span")>=0?f:g).substring(h.indexOf(">")+1,h.indexOf("</")).replace(",","");b.indexOf(",")>=0;)b=b.replace(",","");var v=c*parseFloat(b);if(!(v<=threshold_weight))return;c=v}else c=0;if(!created){created=!0,dt=$("#dataTable").DataTable({order:[[7,"desc"]],lengthMenu:[[-1],["All"]],responsive:!0,dom:"Bfrtip",buttons:["copy","csv","excel","pdf","print"]});$("#dataTable thead th").each(function(e){var t=dt.column(e).header(),o=document.createElement("button");o.innerHTML=t.innerHTML,$(o).addClass("colvistoggle"),$(o).addClass("btn"),$(o).addClass("btn-default"),$(o).attr("colidx",e),$(o).addClass("is-true"),dt.column($(o).attr("colidx")).visible(!0),$(o).on("click",function(e){e.preventDefault();var t=dt.column($(this).attr("colidx"));$(this).removeClass("is-"+t.visible()),t.visible(!t.visible()),$(this).addClass("is-"+t.visible())});var s=document.createElement("li");$(s).append($(o)),$("#colvis").append($(s))}),$("#show-hide").show(),$(".dropdown").on("show.bs.dropdown",function(e){$(this).find(".dropdown-menu").first().stop(!0,!0).slideDown()}),$(".dropdown").on("hide.bs.dropdown",function(e){$(this).find(".dropdown-menu").first().stop(!0,!0).slideUp()}),$("#dataTable tbody").on("mousedown","tr",function(e){if(1===e.which)if(e.ctrlKey){var t=$(this).attr("id").split("_")[0]+"_"+$(this).attr("id").split("_")[1]+"_"+$(this).attr("id").split("_")[2];$(this).hasClass("row-selected")?$.each($("."+t),function(){$(this).removeClass("row-selected")}):$.each($("."+t),function(){$(this).addClass("row-selected")})}else e.shiftKey?open_popup($(this).attr("id").split("_")[0],$(this).children()[0].textContent,$(this).attr("id").split("_")[1],parseInt($(this).attr("id").split("_")[2])):$(this).hasClass("row-selected")?$(this).removeClass("row-selected"):$(this).addClass("row-selected")}),$("label > input").addClass("form-control").addClass("minor-text"),$("label > input").attr("placeholder","Search Results..."),$(".loading").hide(),$("#dataTable").show(),$(".data_options").append($("#dataTable_filter")),$(".data_options").append($(".dt-buttons")),$(".dt-button").addClass("btn"),$(".dt-button").addClass("btn-default")}var _=[t,numberWithCommas(o.toFixed(2)),s.split("-")[0],numberWithCommas(r.toFixed(2)),p,numberWithCommas(l.toFixed(2)),s.split("-")[1],numberWithCommas(i.toFixed(2)),numberWithCommas(d.toFixed(2)),(100*n.toFixed(3)).toFixed(1)+"%",numberWithCommas(c.toFixed(2))],y=$("#dataTable").dataTable().fnAddData(_),C=$("#dataTable").dataTable().fnGetNodes(y);$(C).attr("id",m+"_"+$("."+m).length),$(C).addClass(m)}function buyComparator(e,t){if(isStationBuying){if(e[0]>t[0])return 1;if(e[0]<t[0])return-1}else{if(e[0]>t[0])return-1;if(e[0]<t[0])return 1}return 0}function sellComparator(e,t){if(isStationBuying){if(e[0]>t[0])return-1;if(e[0]<t[0])return 1}else{if(e[0]>t[0])return 1;if(e[0]<t[0])return-1}return 0}function getPrice(e,t,o,s){for(var r=[],a=0;a<e.length;a++){var i=e[a],n=!1;if(!0===i.is_buy_order&&"buy"===o?n=!0:!1===i.is_buy_order&&"sell"===o&&(n=!0),t==i.location_id&&1===i.min_volume&&n){var l=i.price,d=i.volume_remain;r.push([l,d])}}return"sell"==o?(r=r.sort(buyComparator),saveBuyData(t,s,$.extend(!0,[],r))):(r=r.sort(sellComparator),saveSellData(t,s,$.extend(!0,[],r))),r}function saveBuyData(e,t,o){customBuy[e]?customBuy[e][t]=o:(customBuy[e]=[],customBuy[e][t]=o)}function saveSellData(e,t,o){customSell[e]?customSell[e][t]=o:(customSell[e]=[],customSell[e][t]=o)}function addMarginRow(e,t,o,s,r){var a=s-o,i=(s-o)/s;if(!created){created=!0,dt=$("#dataTable").DataTable({order:[[5,"desc"]],lengthMenu:[[-1],["All"]],responsive:!0,dom:"Bfrtip",buttons:["copy","csv","excel","pdf","print"]});$("#dataTable thead th").each(function(e){var t=dt.column(e).header(),o=document.createElement("button"),s=[];o.innerHTML=t.innerHTML,$(o).addClass("colvistoggle"),$(o).addClass("btn"),$(o).addClass("btn-default"),$(o).attr("colidx",e),$(o).addClass("is-true"),dt.column($(o).attr("colidx")).visible(!0);for(e=0;e<s.length;e++)if(o.innerHTML===s[e]){$(o).addClass("is-false"),dt.column($(o).attr("colidx")).visible(!1);break}$(o).on("click",function(e){e.preventDefault();var t=dt.column($(this).attr("colidx"));$(this).removeClass("is-"+t.visible()),t.visible(!t.visible()),$(this).addClass("is-"+t.visible())});var r=document.createElement("li");$(r).append($(o)),$("#colvis").append($(r))}),$("#show-hide").show(),$(".dropdown").on("show.bs.dropdown",function(e){$(this).find(".dropdown-menu").first().stop(!0,!0).slideDown()}),$(".dropdown").on("hide.bs.dropdown",function(e){$(this).find(".dropdown-menu").first().stop(!0,!0).slideUp()}),$("#dataTable tbody").on("mousedown","tr",function(e){1===e.which&&($(this).hasClass("row-selected")?$(this).removeClass("row-selected"):$(this).addClass("row-selected"))}),$("label > input").addClass("form-control").addClass("minor-text"),$("label > input").attr("placeholder","Search Results..."),$(".loading").hide(),$("#dataTable").show(),$(".data_options").append($("#dataTable_filter")),$(".data_options").append($(".dt-buttons")),$(".dt-button").addClass("btn"),$(".dt-button").addClass("btn-default")}var n=[t,numberWithCommas(o.toFixed(2)),numberWithCommas(s.toFixed(2)),numberWithCommas(a.toFixed(2)),(100*i.toFixed(3)).toFixed(1)+"%",numberWithCommas(r)];$("#dataTable").dataTable().fnAddData(n)}