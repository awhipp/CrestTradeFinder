var dt,station_buy,buy_orders,sell_orders,increment,total_progress,SECOND_DELAY=0,PAGES=40,stations=[],created=!1,isStationBuying=!1;function getData(e,t,o,r){var s,i=[];if("string"==typeof e?s=[e]:null!=e&&(s=getPrice(e,t,o,r)),s)for(var n=0;n<s.length;n++)s[n][0]>0&&i.push(s[n]);return i}function beginStation(e){beginRoute(e,e)}function beginRoute(e,t){e==t&&(isStationBuying=!0,t=[t]),station_buy=e,(buy_orders={}).complete=!1,buy_orders.region=station_buy[0],buy_orders.station=station_buy[1],buy_orders.complete_pages=0,increment=100/(t.length+1)/PAGES,total_progress=0;for(var o=1;o<=PAGES;o++)getOrders(o,station_buy[0],station_buy[1],buy_orders);stations=t,sell_orders=[];for(var r=0;r<t.length;r++){sell_orders[r]={},sell_orders[r].complete=!1;var s=t[r][0],i=t[r][1];sell_orders[r].region=s,sell_orders[r].station=i,sell_orders[r].complete_pages=0;for(o=1;o<=PAGES;o++)getOrders(o,s,i,sell_orders[r])}$("#selection").hide()}var shown=!1;function displayError(){shown||($("#connectEVE").slideToggle(!0),shown=!0)}function hideError(){shown&&($("#connectEVE").slideToggle(),shown=!1)}var errorPages={};function getOrders(e,t,o,r){t=parseInt(t),o=parseInt(o);var s="https://esi.tech.ccp.is/latest/markets/"+t+"/orders/?datasource=tranquility&page="+e;$.ajax({type:"get",url:s,dataType:"json",contentType:"application/json",success:function(e){if(r.complete_pages+=1,total_progress+=increment,$(".loading").html("<b>Getting orders: "+total_progress.toFixed(2)+"% complete</b>"),r.complete_pages==PAGES)executeOrders();else for(var t=0;t<e.length;t++)if(e[t].location_id===o){var s=e[t].type_id;r[s]||(r[s]=[]),r[s].push(e[t])}},error:function(){displayError(),errorPages[""+e]?errorPages[""+e]+=1:errorPages[""+e]=1,errorPages[""+e]>3?(r.complete_pages+=1,total_progress+=increment,$(".loading").html("<b>Getting orders: "+total_progress.toFixed(2)+"% complete</b>"),r.complete_pages==PAGES&&executeOrders()):getOrders(e,t,o,r)}})}function executeOrders(){for(var e=!0,t=0;t<sell_orders.length;t++)sell_orders[t].complete_pages!==PAGES?e=!1:sell_orders[t].complete=!0;if(buy_orders.complete_pages===PAGES&&(buy_orders.complete=!0),!0===buy_orders.complete&&e){for(itemid in total_progress=100,$(".loading").text("Getting orders: "+total_progress.toFixed(2)+"% complete"),buy_orders)itemids.push(itemid);return executeNext(),void hideError()}}var executingInterval,executingCount=0,itemids=[];function executeNext(){executingInterval=setInterval(function(){for(;0!=itemids.length&&executingCount<1500;){executingCount++,next(itemids.splice(0,1)[0])}0==itemids.length&&0==executingCount&&(clearInterval(executingInterval),$(".loading").text("No trades found for your filters."))},1e3)}function next(e){var t;(t=getData(buy_orders[e],buy_orders.station,"sell",e)).length>0?executeRowCompute(e,t):executingCount--}function executeRowCompute(e,t){var o=!1;if("complete"!==e||"station"!==e||"region"!==e||"complete_pages"!=e)for(var r=0;r<sell_orders.length;r++)if(void 0!==sell_orders[r][e]){var s=getData(sell_orders[r][e],sell_orders[r].station,"buy",e);if(s.length>0)o=!0,getItemInfo(e,t,s,[sell_orders[r].region,sell_orders[r].station])}o||executingCount--}function getItemInfo(e,t,o,r){for(var s=[],i=o[0][0],n=t[0][0],a=0;a<t.length;a++)for(var l=0;l<o.length;l++){if(isStationBuying)o[l][0]>n&&(n=o[l][0]),t[a][0]<i&&(i=t[a][0]);else(d=calculateRow(e,t[a][0],t[a][1],o[l][0],o[l][1],r)).length>0&&s.push(d)}if(isStationBuying){var d={},u=((o=n)-(t=i))/o;100*u>=threshold_margin_lower&&100*u<=threshold_margin_upper&&o-t>1e3?(d.buyPrice=t,d.sellPrice=o,s.push(d),s.length>0?getItemVolume(e,s=s.sort(rowComparator)):executingCount--):executingCount--}else s.length>0?getItemWeight(e,s=s.sort(rowComparator)):executingCount--}var filteringInterval,count=0;function updateFilterCount(){filteringInterval=setInterval(function(){count++;for(var e="",t=0;t<count%5;t++)e+=".";$("#filtering-data").html("<b>Filtering Results. Please wait"+e+"</b></br>If it takes too long try a smaller margin range."),0==executingCount&&(clearInterval(filteringInterval),$("#filtering-data").remove())},1e3)}var filtered=!1;function getItemVolume(e,t){filtered||(filtered=!0,$("#buyingFooter").append("<div id='filtering-data'><b>Filtering Results. Please wait.</b></br>If it takes too long try a smaller margin range.</div>"),updateFilterCount()),$.ajax({type:"get",url:"https://esi.tech.ccp.is/latest/markets/"+stations[0][0]+"/history/?datasource=tranquility&type_id="+e+"&language=en-us",dataType:"json",async:!0,contentType:"application/json",success:function(o){var r=t[0];o&&o[o.length-1]&&o[o.length-1].volume?(r.volume=o[o.length-1].volume,r.volume>=volume_threshold?getItemWeight(e,t):executingCount--):executingCount--},error:function(o,r){404!=o.status&&"parsererror"!==o.statusText?getItemVolume(e,t):executingCount--}})}var itemWeightCache={};function getItemWeight(e,t){if(itemWeightCache[e]){var o=itemWeightCache[e][0],r=itemWeightCache[e][1],s=t[0];isStationBuying?addMarginRow(e,o,s.buyPrice,s.sellPrice):addRow(s[0],o,s[1],s[2],s[3],s[4],s[5],s[6],s[7],s[8],s[9],r),executingCount--}else $.ajax({type:"get",url:"https://esi.tech.ccp.is/latest/universe/types/"+e+"/?datasource=tranquility&language=en-us",dataType:"json",async:!0,contentType:"application/json",success:function(o){executingCount--;var r=o.name,s=o.volume;itemWeightCache[e]=[],itemWeightCache[e][0]=r,itemWeightCache[e][1]=s;var i=t[0];isStationBuying?addMarginRow(e,r,i.buyPrice,i.sellPrice,i.volume):addRow(i[0],r,i[1],i[2],i[3],i[4],i[5],i[6],i[7],i[8],i[9],s)},error:function(o,r){404!=o.status&&"parsererror"!==o.statusText?getItemWeight(e,t):executingCount--}})}function rowComparator(e,t){return e[5]<t[5]?1:e[5]>t[5]?-1:0}function calculateRow(e,t,o,r,s,i){if(t<r&&r>0){var n,a,l,d=r-t;o>=s?(l=numberWithCommas(o.toFixed())+"-<span class='selected_volume'>"+numberWithCommas(s.toFixed())+"</span>",n=s*d,a=t*s):(l="<span class='selected_volume'>"+numberWithCommas(o.toFixed())+"</span>-"+numberWithCommas(s.toFixed()),n=o*d,a=t*o);var u=getLocation(i[1]),c=(r-t)/t;return n>=threshold_profit&&(100*c.toFixed(3)).toFixed(1)>=threshold_roi&&a<=threshold_cost?[e,t,l,a,u,n,c,r,d,i,void 0]:[]}return[]}function getLocation(e){return isCustom?getCustomEnd(e):e===JITA[1]?"Jita":e===AMARR[1]?"Amarr":e===DODIXIE[1]?"Dodixie":e===RENS[1]?"Rens":e===HEK[1]?"Hek":getCustomEnd(e)}function getCustomEnd(e){for(var t=0;t<stations.length;t++)if(e===stations[t][1])return customEnd[t];return"nil"}function addRow(e,t,o,r,s,i,n,a,l,d,u,c){for(var p=i+"";-1!=i.indexOf("(");)i=i.replace("(","");for(;-1!=i.indexOf(")");)i=i.replace(")","");var m=e+"_"+i+"_"+u[1];if(c){for(var g,h=r.split("-")[0],f=r.split("-")[1],b=(g=h.indexOf("span")>=0?h:f).substring(g.indexOf(">")+1,g.indexOf("</")).replace(",","");b.indexOf(",")>=0;)b=b.replace(",","");var v=c*parseFloat(b);if(!(v<=threshold_weight))return;c=v}else c=0;if(!created){created=!0,dt=$("#dataTable").DataTable({order:[[7,"desc"]],lengthMenu:[[-1],["All"]],responsive:!0,dom:"Bfrtip",buttons:["copy","csv","excel","pdf","print"]});$("#dataTable thead th").each(function(e){var t=dt.column(e).header(),o=document.createElement("button");o.innerHTML=t.innerHTML,$(o).addClass("colvistoggle"),$(o).addClass("btn"),$(o).addClass("btn-default"),$(o).attr("colidx",e),$(o).addClass("is-true"),dt.column($(o).attr("colidx")).visible(!0),$(o).on("click",function(e){e.preventDefault();var t=dt.column($(this).attr("colidx"));$(this).removeClass("is-"+t.visible()),t.visible(!t.visible()),$(this).addClass("is-"+t.visible())});var r=document.createElement("li");$(r).append($(o)),$("#colvis").append($(r))}),$("#show-hide").show(),$(".dropdown").on("show.bs.dropdown",function(e){$(this).find(".dropdown-menu").first().stop(!0,!0).slideDown()}),$(".dropdown").on("hide.bs.dropdown",function(e){$(this).find(".dropdown-menu").first().stop(!0,!0).slideUp()}),$("#dataTable tbody").on("mousedown","tr",function(e){if(1===e.which)if(e.ctrlKey){var t=$(this).attr("id").split("_")[0]+"_"+$(this).attr("id").split("_")[1]+"_"+$(this).attr("id").split("_")[2];$(this).hasClass("row-selected")?$.each($("."+t),function(){$(this).removeClass("row-selected")}):$.each($("."+t),function(){$(this).addClass("row-selected")})}else e.shiftKey?open_popup($(this).attr("id").split("_")[0],$(this).children()[0].textContent,$(this).attr("id").split("_")[1],parseInt($(this).attr("id").split("_")[2])):$(this).hasClass("row-selected")?$(this).removeClass("row-selected"):$(this).addClass("row-selected")}),$("label > input").addClass("form-control").addClass("minor-text"),$("label > input").attr("placeholder","Search Results..."),$(".loading").hide(),$("#dataTable").show(),$(".data_options").append($("#dataTable_filter")),$(".data_options").append($(".dt-buttons")),$(".dt-button").addClass("btn"),$(".dt-button").addClass("btn-default")}var _=[t,numberWithCommas(o.toFixed(2)),r.split("-")[0],numberWithCommas(s.toFixed(2)),p,numberWithCommas(l.toFixed(2)),r.split("-")[1],numberWithCommas(n.toFixed(2)),numberWithCommas(d.toFixed(2)),(100*a.toFixed(3)).toFixed(1)+"%",numberWithCommas(c.toFixed(2))],C=$("#dataTable").dataTable().fnAddData(_),x=$("#dataTable").dataTable().fnGetNodes(C);$(x).attr("id",m+"_"+$("."+m).length),$(x).addClass(m)}function buyComparator(e,t){if(isStationBuying){if(e[0]>t[0])return 1;if(e[0]<t[0])return-1}else{if(e[0]>t[0])return-1;if(e[0]<t[0])return 1}return 0}function sellComparator(e,t){if(isStationBuying){if(e[0]>t[0])return-1;if(e[0]<t[0])return 1}else{if(e[0]>t[0])return 1;if(e[0]<t[0])return-1}return 0}function getPrice(e,t,o,r){for(var s=[],i=0;i<e.length;i++){var n=e[i],a=!1;if(!0===n.is_buy_order&&"buy"===o?a=!0:!1===n.is_buy_order&&"sell"===o&&(a=!0),t==n.location_id&&1===n.min_volume&&a){var l=n.price,d=n.volume_remain;s.push([l,d])}}return"sell"==o?(s=s.sort(buyComparator),saveBuyData(t,r,$.extend(!0,[],s))):(s=s.sort(sellComparator),saveSellData(t,r,$.extend(!0,[],s))),s}function saveBuyData(e,t,o){customBuy[e]?customBuy[e][t]=o:(customBuy[e]=[],customBuy[e][t]=o)}function saveSellData(e,t,o){customSell[e]?customSell[e][t]=o:(customSell[e]=[],customSell[e][t]=o)}function addMarginRow(e,t,o,r,s){var i=r-o,n=(r-o)/r;if(!created){created=!0,dt=$("#dataTable").DataTable({order:[[5,"desc"]],lengthMenu:[[-1],["All"]],responsive:!0,dom:"Bfrtip",buttons:["copy","csv","excel","pdf","print"]});$("#dataTable thead th").each(function(e){var t=dt.column(e).header(),o=document.createElement("button"),r=[];o.innerHTML=t.innerHTML,$(o).addClass("colvistoggle"),$(o).addClass("btn"),$(o).addClass("btn-default"),$(o).attr("colidx",e),$(o).addClass("is-true"),dt.column($(o).attr("colidx")).visible(!0);for(e=0;e<r.length;e++)if(o.innerHTML===r[e]){$(o).addClass("is-false"),dt.column($(o).attr("colidx")).visible(!1);break}$(o).on("click",function(e){e.preventDefault();var t=dt.column($(this).attr("colidx"));$(this).removeClass("is-"+t.visible()),t.visible(!t.visible()),$(this).addClass("is-"+t.visible())});var s=document.createElement("li");$(s).append($(o)),$("#colvis").append($(s))}),$("#show-hide").show(),$(".dropdown").on("show.bs.dropdown",function(e){$(this).find(".dropdown-menu").first().stop(!0,!0).slideDown()}),$(".dropdown").on("hide.bs.dropdown",function(e){$(this).find(".dropdown-menu").first().stop(!0,!0).slideUp()}),$("#dataTable tbody").on("mousedown","tr",function(e){1===e.which&&($(this).hasClass("row-selected")?$(this).removeClass("row-selected"):$(this).addClass("row-selected"))}),$("label > input").addClass("form-control").addClass("minor-text"),$("label > input").attr("placeholder","Search Results..."),$(".loading").hide(),$("#dataTable").show(),$(".data_options").append($("#dataTable_filter")),$(".data_options").append($(".dt-buttons")),$(".dt-button").addClass("btn"),$(".dt-button").addClass("btn-default")}var a=[t,numberWithCommas(o.toFixed(2)),numberWithCommas(r.toFixed(2)),numberWithCommas(i.toFixed(2)),(100*n.toFixed(3)).toFixed(1)+"%",numberWithCommas(s)];$("#dataTable").dataTable().fnAddData(a)}