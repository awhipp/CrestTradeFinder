var dt,station_buy,buy_orders,sell_orders,increment,total_progress,SECOND_DELAY=0,PAGES=40,stations=[],created=!1,isStationBuying=!1;function getData(e,t,o,s){var a,i=[];if("string"==typeof e?a=[e]:null!=e&&(a=getPrice(e,t,o,s)),a)for(var r=0;r<a.length;r++)a[r][0]>0&&i.push(a[r]);return i}function beginStation(e){beginRoute(e,e)}function beginRoute(e,t){e==t&&(isStationBuying=!0,t=[t]),station_buy=e,(buy_orders={}).complete=!1,buy_orders.region=station_buy[0],buy_orders.station=station_buy[1],buy_orders.complete_pages=0,increment=100/(t.length+1)/PAGES,total_progress=0;for(var o=1;o<=PAGES;o++)getOrders(o,station_buy[0],station_buy[1],buy_orders);stations=t,sell_orders=[];for(var s=0;s<t.length;s++){sell_orders[s]={},sell_orders[s].complete=!1;var a=t[s][0],i=t[s][1];sell_orders[s].region=a,sell_orders[s].station=i,sell_orders[s].complete_pages=0;for(o=1;o<=PAGES;o++)getOrders(o,a,i,sell_orders[s])}$("#selection").hide()}var itemids=[],executingGet=!1,numberOfRequests=0;function next(e){var t;(t=getData(buy_orders[e],buy_orders.station,"sell",e)).length>0?executeRowCompute(e,t):0!=itemids.length||executingGet||created||$(".loading").text("No trades found for your filters.")}var shown=!1;function displayError(){shown||($("#connectEVE").slideToggle(!0),shown=!0)}function hideError(){shown&&($("#connectEVE").slideToggle(),shown=!1)}function getOrders(e,t,o,s){t=parseInt(t),o=parseInt(o);var a="https://esi.tech.ccp.is/latest/markets/"+t+"/orders/?datasource=tranquility&page="+e;$.ajax({type:"get",url:a,dataType:"json",contentType:"application/json",success:function(e){if(s.complete_pages+=1,total_progress+=increment,$(".loading").html("<b>Getting orders: "+total_progress.toFixed(2)+"% complete</b>"),s.complete_pages==PAGES){for(var t=!0,a=0;a<sell_orders.length;a++)sell_orders[a].complete_pages!==PAGES?t=!1:sell_orders[a].complete=!0;if(buy_orders.complete_pages===PAGES&&(buy_orders.complete=!0),!0===buy_orders.complete&&t){for(i in total_progress=100,$(".loading").text("Getting orders: "+total_progress.toFixed(2)+"% complete"),buy_orders)itemids.push(i);for(;0!=itemids.length;){var i=itemids.splice(0,1)[0];next(i)}return void hideError()}}else for(a=0;a<e.length;a++)if(e[a].location_id===o){var r=e[a].type_id;s[r]||(s[r]=[]),s[r].push(e[a])}},error:function(){displayError(),getOrders(e,t,o,s)}})}function executeRowCompute(e,t){if("complete"!==e||"station"!==e||"region"!==e||"complete_pages"!=e)for(var o=0;o<sell_orders.length;o++)if(void 0!==sell_orders[o][e]){var s=getData(sell_orders[o][e],sell_orders[o].station,"buy",e);if(s.length>0)getItemInfo(e,t,s,[sell_orders[o].region,sell_orders[o].station])}}function getItemInfo(e,t,o,s){for(var a=[],i=o[0][0],r=t[0][0],n=0;n<t.length;n++)for(var l=0;l<o.length;l++){if(isStationBuying)o[l][0]>r&&(r=o[l][0]),t[n][0]<i&&(i=t[n][0]);else(d=calculateRow(e,t[n][0],t[n][1],o[l][0],o[l][1],s)).length>0&&a.push(d)}if(isStationBuying){var d={},u=((o=r)-(t=i))/o;100*u>=threshold_margin_lower&&100*u<=threshold_margin_upper&&o-t>1e3&&(d.buyPrice=t,d.sellPrice=o,a.push(d),a.length>0&&getItemVolume(e,a=a.sort(rowComparator)))}else a.length>0&&getItemWeight(e,a=a.sort(rowComparator))}var filteringInterval,count=0;function updateFilterCount(){filteringInterval=setInterval(function(){count++;for(var e="",t=0;t<count%5;t++)e+=".";$("#filtering-data").html("Filtering Data. Please wait"+e),0==executingGet&&(clearInterval(filteringInterval),$("#filtering-data").remove())},1e3)}var filtered=!1;function getItemVolume(e,t){executingGet=!0,filtered||(filtered=!0,$("#buyingFooter").append("<div id='filtering-data'>Filtering Data. Please wait.</div>"),updateFilterCount()),$.ajax({type:"get",url:"https://esi.tech.ccp.is/latest/markets/"+stations[0][0]+"/history/?datasource=tranquility&type_id="+e+"&language=en-us",dataType:"json",async:!0,contentType:"application/json",success:function(o){var s=t[0];s.volume=o[o.length-1].volume,s.volume>=volume_threshold&&numberOfRequests<1e3&&(numberOfRequests++,getItemWeight(e,t))},error:function(o,s){404!=o.status&&(console.log(o),getItemVolume(e,t))}})}var itemWeightCache={};function getItemWeight(e,t){if(itemWeightCache[e]){var o=itemWeightCache[e][0],s=itemWeightCache[e][1],a=t[0];isStationBuying?addMarginRow(e,o,a.buyPrice,a.sellPrice):addRow(a[0],o,a[1],a[2],a[3],a[4],a[5],a[6],a[7],a[8],a[9],s)}else executingGet=!0,$.ajax({type:"get",url:"https://esi.tech.ccp.is/latest/universe/types/"+e+"/?datasource=tranquility&language=en-us",dataType:"json",async:!0,contentType:"application/json",success:function(o){executingGet=!1;var s=o.name,a=o.volume;itemWeightCache[e]=[],itemWeightCache[e][0]=s,itemWeightCache[e][1]=a;var i=t[0];isStationBuying?addMarginRow(e,s,i.buyPrice,i.sellPrice,i.volume):addRow(i[0],s,i[1],i[2],i[3],i[4],i[5],i[6],i[7],i[8],i[9],a)},error:function(o,s){404!=o.status&&(console.log(o),getItemWeight(e,t))}})}function rowComparator(e,t){return e[5]<t[5]?1:e[5]>t[5]?-1:0}function calculateRow(e,t,o,s,a,i){if(t<s&&s>0){var r,n,l,d=s-t;o>=a?(l=numberWithCommas(o.toFixed())+"-<span class='selected_volume'>"+numberWithCommas(a.toFixed())+"</span>",r=a*d,n=t*a):(l="<span class='selected_volume'>"+numberWithCommas(o.toFixed())+"</span>-"+numberWithCommas(a.toFixed()),r=o*d,n=t*o);var u=getLocation(i[1]),c=(s-t)/t;return r>=threshold_profit&&(100*c.toFixed(3)).toFixed(1)>=threshold_roi&&n<=threshold_cost?[e,t,l,n,u,r,c,s,d,i,void 0]:[]}return[]}function getLocation(e){return isCustom?getCustomEnd(e):e===JITA[1]?"Jita":e===AMARR[1]?"Amarr":e===DODIXIE[1]?"Dodixie":e===RENS[1]?"Rens":e===HEK[1]?"Hek":getCustomEnd(e)}function getCustomEnd(e){for(var t=0;t<stations.length;t++)if(e===stations[t][1])return customEnd[t];return"nil"}function addRow(e,t,o,s,a,i,r,n,l,d,u,c){for(var p=i+"";-1!=i.indexOf("(");)i=i.replace("(","");for(;-1!=i.indexOf(")");)i=i.replace(")","");var m=e+"_"+i+"_"+u[1];if(c){for(var h,f=s.split("-")[0],g=s.split("-")[1],b=(h=f.indexOf("span")>=0?f:g).substring(h.indexOf(">")+1,h.indexOf("</")).replace(",","");b.indexOf(",")>=0;)b=b.replace(",","");var v=c*parseFloat(b);if(!(v<=threshold_weight))return;c=v}else c=0;if(!created){created=!0,dt=$("#dataTable").DataTable({order:[[7,"desc"]],lengthMenu:[[-1],["All"]],responsive:!0,dom:"Bfrtip",buttons:["copy","csv","excel","pdf","print"]});$("#dataTable thead th").each(function(e){var t=dt.column(e).header(),o=document.createElement("button");o.innerHTML=t.innerHTML,$(o).addClass("colvistoggle"),$(o).addClass("btn"),$(o).addClass("btn-default"),$(o).attr("colidx",e),$(o).addClass("is-true"),dt.column($(o).attr("colidx")).visible(!0),$(o).on("click",function(e){e.preventDefault();var t=dt.column($(this).attr("colidx"));$(this).removeClass("is-"+t.visible()),t.visible(!t.visible()),$(this).addClass("is-"+t.visible())});var s=document.createElement("li");$(s).append($(o)),$("#colvis").append($(s))}),$("#show-hide").show(),$(".dropdown").on("show.bs.dropdown",function(e){$(this).find(".dropdown-menu").first().stop(!0,!0).slideDown()}),$(".dropdown").on("hide.bs.dropdown",function(e){$(this).find(".dropdown-menu").first().stop(!0,!0).slideUp()}),$("#dataTable tbody").on("mousedown","tr",function(e){if(1===e.which)if(e.ctrlKey){var t=$(this).attr("id").split("_")[0]+"_"+$(this).attr("id").split("_")[1]+"_"+$(this).attr("id").split("_")[2];$(this).hasClass("row-selected")?$.each($("."+t),function(){$(this).removeClass("row-selected")}):$.each($("."+t),function(){$(this).addClass("row-selected")})}else e.shiftKey?open_popup($(this).attr("id").split("_")[0],$(this).children()[0].textContent,$(this).attr("id").split("_")[1],parseInt($(this).attr("id").split("_")[2])):$(this).hasClass("row-selected")?$(this).removeClass("row-selected"):$(this).addClass("row-selected")}),$("label > input").addClass("form-control").addClass("minor-text"),$("label > input").attr("placeholder","Search Results..."),$(".loading").hide(),$("#dataTable").show(),$(".data_options").append($("#dataTable_filter")),$(".data_options").append($(".dt-buttons")),$(".dt-button").addClass("btn"),$(".dt-button").addClass("btn-default")}var _=[t,numberWithCommas(o.toFixed(2)),s.split("-")[0],numberWithCommas(a.toFixed(2)),p,numberWithCommas(l.toFixed(2)),s.split("-")[1],numberWithCommas(r.toFixed(2)),numberWithCommas(d.toFixed(2)),(100*n.toFixed(3)).toFixed(1)+"%",numberWithCommas(c.toFixed(2))],C=$("#dataTable").dataTable().fnAddData(_),y=$("#dataTable").dataTable().fnGetNodes(C);$(y).attr("id",m+"_"+$("."+m).length),$(y).addClass(m)}function buyComparator(e,t){return e[0]>t[0]?-1:e[0]<t[0]?1:0}function sellComparator(e,t){return e[0]>t[0]?1:e[0]<t[0]?-1:0}function getPrice(e,t,o,s){for(var a=[],i=0;i<e.length;i++){var r=e[i],n=!1;if(!0===r.is_buy_order&&"buy"===o?n=!0:!1===r.is_buy_order&&"sell"===o&&(n=!0),t==r.location_id&&1===r.min_volume&&n){var l=r.price,d=r.volume_remain;a.push([l,d])}}return"sell"==o?(a=a.sort(buyComparator),saveBuyData(t,s,$.extend(!0,[],a))):(a=a.sort(sellComparator),saveSellData(t,s,$.extend(!0,[],a))),a}function saveBuyData(e,t,o){customBuy[e]?customBuy[e][t]=o:(customBuy[e]=[],customBuy[e][t]=o)}function saveSellData(e,t,o){customSell[e]?customSell[e][t]=o:(customSell[e]=[],customSell[e][t]=o)}function addMarginRow(e,t,o,s,a){var i=s-o,r=(s-o)/s;if(!created){created=!0,dt=$("#dataTable").DataTable({order:[[5,"desc"]],lengthMenu:[[-1],["All"]],responsive:!0,dom:"Bfrtip",buttons:["copy","csv","excel","pdf","print"]});$("#dataTable thead th").each(function(e){var t=dt.column(e).header(),o=document.createElement("button"),s=[];o.innerHTML=t.innerHTML,$(o).addClass("colvistoggle"),$(o).addClass("btn"),$(o).addClass("btn-default"),$(o).attr("colidx",e),$(o).addClass("is-true"),dt.column($(o).attr("colidx")).visible(!0);for(e=0;e<s.length;e++)if(o.innerHTML===s[e]){$(o).addClass("is-false"),dt.column($(o).attr("colidx")).visible(!1);break}$(o).on("click",function(e){e.preventDefault();var t=dt.column($(this).attr("colidx"));$(this).removeClass("is-"+t.visible()),t.visible(!t.visible()),$(this).addClass("is-"+t.visible())});var a=document.createElement("li");$(a).append($(o)),$("#colvis").append($(a))}),$("#show-hide").show(),$(".dropdown").on("show.bs.dropdown",function(e){$(this).find(".dropdown-menu").first().stop(!0,!0).slideDown()}),$(".dropdown").on("hide.bs.dropdown",function(e){$(this).find(".dropdown-menu").first().stop(!0,!0).slideUp()}),$("#dataTable tbody").on("mousedown","tr",function(e){1===e.which&&($(this).hasClass("row-selected")?$(this).removeClass("row-selected"):$(this).addClass("row-selected"))}),$("label > input").addClass("form-control").addClass("minor-text"),$("label > input").attr("placeholder","Search Results..."),$(".loading").hide(),$("#dataTable").show(),$(".data_options").append($("#dataTable_filter")),$(".data_options").append($(".dt-buttons")),$(".dt-button").addClass("btn"),$(".dt-button").addClass("btn-default")}var n=[t,numberWithCommas(o.toFixed(2)),numberWithCommas(s.toFixed(2)),numberWithCommas(i.toFixed(2)),(100*r.toFixed(3)).toFixed(1)+"%",numberWithCommas(a)];$("#dataTable").dataTable().fnAddData(n)}