var SECOND_DELAY=0;var PAGES=40;var stations=[];var created=false;var dt;var iteration=0;var isStationBuying=false;var station_buy,stations;function getData(e,d,b,g){var a=[];var f;if(typeof(e)=="string"){f=[e]}else{if(e!=null){f=getPrice(e,d,b,g)}}if(f){for(var c=0;c<f.length;c++){if(f[c][0]>0){a.push(f[c])}}}return a}var buy_orders,sell_orders,increment,total_progress;function beginStation(b){beginRoute(b,b)}function beginRoute(c,d){if(c==d){isStationBuying=true;d=[d]}station_buy=c;buy_orders={};buy_orders.complete=false;buy_orders.region=station_buy[0];buy_orders.station=station_buy[1];buy_orders.complete_pages=0;increment=100/(d.length+1)/PAGES;total_progress=0;for(var a=1;a<=PAGES;a++){getOrders(a,station_buy[0],station_buy[1],buy_orders)}stations=d;sell_orders=[];for(var b=0;b<d.length;b++){sell_orders[b]={};sell_orders[b]["complete"]=false;var f=d[b][0];var e=d[b][1];sell_orders[b]["region"]=f;sell_orders[b]["station"]=e;sell_orders[b]["complete_pages"]=0;for(var a=1;a<=PAGES;a++){getOrders(a,f,e,sell_orders[b])}}$("#selection").hide()}var shown=false;function displayError(){if(!shown){$("#connectEVE").slideToggle(true);shown=true}}function hideError(){if(shown){$("#connectEVE").slideToggle();shown=false}}var errorPages={};function getOrders(c,d,b,e){d=parseInt(d);b=parseInt(b);var a="https://esi.tech.ccp.is/latest/markets/"+d+"/orders/?datasource=tranquility&page="+c+"&language=en-us&iteration="+iteration;$.ajax({type:"get",url:a,dataType:"json",contentType:"application/json",async:true,cache:false,success:function(g){e.complete_pages+=1;total_progress+=increment;$(".loading").html("<b>Getting orders: "+total_progress.toFixed(2)+"% complete</b>");if(e.complete_pages==PAGES){executeOrders()}else{for(var f=0;f<g.length;f++){if(g[f]["location_id"]===b){var h=g[f]["type_id"];if(!e[h]){e[h]=[]}e[h].push(g[f])}}}},error:function(){displayError();if(errorPages[""+c]){errorPages[""+c]+=1}else{errorPages[""+c]=1}if(errorPages[""+c]>3){e.complete_pages+=1;total_progress+=increment;$(".loading").html("<b>Getting orders: "+total_progress.toFixed(2)+"% complete</b>");if(e.complete_pages==PAGES){executeOrders()}}else{getOrders(c,d,b,e)}}})}function executeOrders(){var b=true;for(var a=0;a<sell_orders.length;a++){if(sell_orders[a]["complete_pages"]!==PAGES){b=false}else{sell_orders[a]["complete"]=true}}if(buy_orders.complete_pages===PAGES){buy_orders.complete=true}if(buy_orders.complete===true&&b){total_progress=100;$(".loading").text("Getting orders: "+total_progress.toFixed(2)+"% complete");for(itemid in buy_orders){itemids.push(itemid)}executeNext();hideError();return}}var executingCount=0;var itemids=[];var executingInterval;var refreshInterval;var secondsToRefresh=120;function executeNext(){executingInterval=setInterval(function(){while(itemids.length!=0&&executingCount<1500){executingCount++;var a=itemids.splice(0,1)[0];next(a)}if(itemids.length==0&&executingCount==0){clearInterval(executingInterval);$(".loading").text("No trades found for your filters.");$("#buyingFooter").append('<div id="refresh-timer"></div>');refreshInterval=setInterval(function(){if(secondsToRefresh<=0){clearInterval(refreshInterval);$("#refresh-timer").remove();$("#buyingFooter").append('<div id="refresh-button"><br><input type="button" class="btn btn-default" onclick="refresh()" value="Refresh Table with Last Query"/></div>')}else{$("#refresh-timer").html("<br><p>Refresh allowed in: "+secondsToRefresh+" seconds.");secondsToRefresh--}},1000);iteration++}},1000)}function next(b){var a=[];a=getData(buy_orders[b],buy_orders.station,"sell",b);if(a.length>0){executeRowCompute(b,a)}else{executingCount--}}function executeRowCompute(e,a){var c=false;if(e!=="complete"||e!=="station"||e!=="region"||e!="complete_pages"){for(var b=0;b<sell_orders.length;b++){if(sell_orders[b][e]!==undefined){var d=getData(sell_orders[b][e],sell_orders[b]["station"],"buy",e);if(d.length>0){var f=[sell_orders[b]["region"],sell_orders[b]["station"]];c=true;getItemInfo(e,a,d,f)}}}}if(!c){executingCount--}}function getItemInfo(h,c,g,l){var n=[];var k=g[0][0];var b=c[0][0];for(var f=0;f<c.length;f++){for(var e=0;e<g.length;e++){if(!isStationBuying){var m=calculateRow(h,c[f][0],c[f][1],g[e][0],g[e][1],l);if(m.length>0){n.push(m)}}else{if(g[e][0]>b){b=g[e][0]}if(c[f][0]<k){k=c[f][0]}}}}if(isStationBuying){var m={};var c=k;var g=b;var a=g-c;var d=(g-c)/g;if(d*100>=threshold_margin_lower&&d*100<=threshold_margin_upper&&a>1000){m.buyPrice=c;m.sellPrice=g;n.push(m);if(n.length>0){n=n.sort(rowComparator);getItemVolume(h,n)}else{executingCount--}}else{executingCount--}}else{if(n.length>0){n=n.sort(rowComparator);getItemWeight(h,n)}else{executingCount--}}}var count=0;var filteringInterval;function updateFilterCount(){filteringInterval=setInterval(function(){count++;var b="";for(var a=0;a<(count%5);a++){b+="."}$("#filtering-data").html("<b>Filtering Results. Please wait"+b+"</b></br>If it takes too long try a smaller margin range.");if(executingCount==0){clearInterval(filteringInterval);$("#filtering-data").remove()}},1000)}var filtered=false;function getItemVolume(b,a){if(!filtered){filtered=true;$("#buyingFooter").append("<div id='filtering-data'><b>Filtering Results. Please wait.</b></br>If it takes too long try a smaller margin range.</div>");updateFilterCount()}$.ajax({type:"get",url:"https://esi.tech.ccp.is/latest/markets/"+stations[0][0]+"/history/?datasource=tranquility&type_id="+b+"&language=en-us&iteration="+iteration,dataType:"json",async:true,cache:false,contentType:"application/json",success:function(c){var d=a[0];if(c&&c[c.length-1]&&c[c.length-1].volume){d.volume=c[c.length-1].volume;if(d.volume>=volume_threshold){getItemWeight(b,a)}else{executingCount--}}else{executingCount--}},error:function(d,c){if(d.status!=404&&d.statusText!=="parsererror"){getItemVolume(b,a)}else{executingCount--}}})}var itemWeightCache={};function getItemWeight(e,c){if(itemWeightCache[e]){var a=itemWeightCache[e][0];var b=itemWeightCache[e][1];var d=c[0];if(isStationBuying){addMarginRow(e,a,d.buyPrice,d.sellPrice,d.volume)}else{addRow(d[0],a,d[1],d[2],d[3],d[4],d[5],d[6],d[7],d[8],d[9],b)}executingCount--}else{$.ajax({type:"get",url:"https://esi.tech.ccp.is/latest/universe/types/"+e+"/?datasource=tranquility&language=en-us&iteration="+iteration,dataType:"json",async:true,cache:false,contentType:"application/json",success:function(i){executingCount--;var f=i.name;var g=i.volume;itemWeightCache[e]=[];itemWeightCache[e][0]=f;itemWeightCache[e][1]=g;var h=c[0];if(isStationBuying){addMarginRow(e,f,h.buyPrice,h.sellPrice,h.volume)}else{addRow(h[0],f,h[1],h[2],h[3],h[4],h[5],h[6],h[7],h[8],h[9],g)}},error:function(g,f){if(g.status!=404&&g.statusText!=="parsererror"){getItemWeight(e,c)}else{executingCount--}}})}}function rowComparator(d,c){if(d[5]<c[5]){return 1}if(d[5]>c[5]){return -1}return 0}function calculateRow(g,h,d,m,f,j){if(h<m&&m>0){var e=m-h;var a;var b;var c;var l;if(d>=f){c=numberWithCommas(d.toFixed())+"-<span class='selected_volume'>"+numberWithCommas(f.toFixed())+"</span>";a=f*e;b=h*f}else{c="<span class='selected_volume'>"+numberWithCommas(d.toFixed())+"</span>-"+numberWithCommas(f.toFixed());a=d*e;b=h*d}var i=getLocation(j[1]);var k=(m-h)/h;if(a>=threshold_profit&&(k.toFixed(3)*100).toFixed(1)>=threshold_roi&&b<=threshold_cost){return[g,h,c,b,i,a,k,m,e,j,l]}else{return[]}}return[]}function getLocation(a){if(isCustom){return getCustomEnd(a)}else{return(a===JITA[1]?"Jita":a===AMARR[1]?"Amarr":a===DODIXIE[1]?"Dodixie":a===RENS[1]?"Rens":a===HEK[1]?"Hek":getCustomEnd(a))}}function getCustomEnd(a){for(var b=0;b<stations.length;b++){if(a===stations[b][1]){return customEnd[b]}}return"nil"}function addRow(o,t,d,v,e,c,h,r,x,i,n,w){var f=c+"";while(c.indexOf("(")!=-1){c=c.replace("(","")}while(c.indexOf(")")!=-1){c=c.replace(")","")}var p=o+"_"+c+"_"+n[1];if(w){var s=v.split("-")[0];var q=v.split("-")[1];var b;if(s.indexOf("span")>=0){b=s}else{b=q}var m=b.substring(b.indexOf(">")+1,b.indexOf("</"));var k=m.replace(",","");while(k.indexOf(",")>=0){k=k.replace(",","")}var u=w*parseFloat(k);if(u<=threshold_weight){w=u}else{return}}else{w=0}if(!created){created=true;dt=$("#dataTable").DataTable({order:[[7,"desc"]],lengthMenu:[[-1],["All"]],responsive:true,dom:"Bfrtip",buttons:["copy","csv","excel","pdf","print"]});var a=0;$("#dataTable thead th").each(function(A){var z=dt.column(A).header();var C=document.createElement("button");C.innerHTML=z.innerHTML;$(C).addClass("colvistoggle");$(C).addClass("btn");$(C).addClass("btn-default");$(C).attr("colidx",A);$(C).addClass("is-true");var B=dt.column($(C).attr("colidx"));B.visible(true);$(C).on("click",function(E){E.preventDefault();var D=dt.column($(this).attr("colidx"));$(this).removeClass("is-"+D.visible());D.visible(!D.visible());$(this).addClass("is-"+D.visible())});var y=document.createElement("li");$(y).append($(C));$("#colvis").append($(y))});$("#show-hide").show();$(".dropdown").on("show.bs.dropdown",function(y){$(this).find(".dropdown-menu").first().stop(true,true).slideDown()});$(".dropdown").on("hide.bs.dropdown",function(y){$(this).find(".dropdown-menu").first().stop(true,true).slideUp()});$("#dataTable tbody").on("mousedown","tr",function(z){if(z.which===1){if(z.ctrlKey){var y=$(this).attr("id").split("_")[0]+"_"+$(this).attr("id").split("_")[1]+"_"+$(this).attr("id").split("_")[2];if(!$(this).hasClass("row-selected")){$.each($("."+y),function(){$(this).addClass("row-selected")})}else{$.each($("."+y),function(){$(this).removeClass("row-selected")})}}else{if(z.shiftKey){open_popup($(this).attr("id").split("_")[0],$(this).children()[0].textContent,$(this).attr("id").split("_")[1],parseInt($(this).attr("id").split("_")[2]))}else{if(!$(this).hasClass("row-selected")){$(this).addClass("row-selected")}else{$(this).removeClass("row-selected")}}}}});$("label > input").addClass("form-control").addClass("minor-text");$("label > input").attr("placeholder","Search Results...");$(".loading").hide();$("#dataTable").show();$(".data_options").append($("#dataTable_filter"));$(".data_options").append($(".dt-buttons"));$(".dt-button").addClass("btn");$(".dt-button").addClass("btn-default");$("#core").css("display","block")}var l=[t,numberWithCommas(d.toFixed(2)),v.split("-")[0],numberWithCommas(e.toFixed(2)),f,numberWithCommas(x.toFixed(2)),v.split("-")[1],numberWithCommas(h.toFixed(2)),numberWithCommas(i.toFixed(2)),(r.toFixed(3)*100).toFixed(1)+"%",numberWithCommas(w.toFixed(2))];var j=$("#dataTable").dataTable().fnAddData(l);var g=$("#dataTable").dataTable().fnGetNodes(j);$(g).attr("id",p+"_"+$("."+p).length);$(g).addClass(p)}function buyComparator(d,c){if(isStationBuying){if(d[0]>c[0]){return 1}if(d[0]<c[0]){return -1}}else{if(d[0]>c[0]){return -1}if(d[0]<c[0]){return 1}}return 0}function sellComparator(d,c){if(isStationBuying){if(d[0]>c[0]){return -1}if(d[0]<c[0]){return 1}}else{if(d[0]>c[0]){return 1}if(d[0]<c[0]){return -1}}return 0}function getPrice(e,d,j,i){var h=[];var k=[];for(var b=0;b<e.length;b++){var c=e[b];var a=false;if(c.is_buy_order===true&&j==="buy"){a=true}else{if(c.is_buy_order===false&&j==="sell"){a=true}}if(d==c.location_id&&c.min_volume===1&&a){var g=c.price;var f=c.volume_remain;h.push([g,f])}}if(j=="sell"){h=h.sort(buyComparator);saveBuyData(d,i,$.extend(true,[],h))}else{h=h.sort(sellComparator);saveSellData(d,i,$.extend(true,[],h))}return h}function saveBuyData(b,c,a){if(customBuy[b]){customBuy[b][c]=a}else{customBuy[b]=[];customBuy[b][c]=a}}function saveSellData(b,c,a){if(customSell[b]){customSell[b][c]=a}else{customSell[b]=[];customSell[b][c]=a}}function addMarginRow(h,j,b,f,d){var a=f-b;var c=(f-b)/f;if(!created){created=true;dt=$("#dataTable").DataTable({order:[[5,"desc"]],lengthMenu:[[-1],["All"]],responsive:true,dom:"Bfrtip",buttons:["copy","csv","excel","pdf","print"]});var i=0;$("#dataTable thead th").each(function(n){var l=dt.column(n).header();var p=document.createElement("button");var m=[];p.innerHTML=l.innerHTML;$(p).addClass("colvistoggle");$(p).addClass("btn");$(p).addClass("btn-default");$(p).attr("colidx",n);$(p).addClass("is-true");var o=dt.column($(p).attr("colidx"));o.visible(true);for(var n=0;n<m.length;n++){if(p.innerHTML===m[n]){$(p).addClass("is-false");var o=dt.column($(p).attr("colidx"));o.visible(false);break}}$(p).on("click",function(r){r.preventDefault();var q=dt.column($(this).attr("colidx"));$(this).removeClass("is-"+q.visible());q.visible(!q.visible());$(this).addClass("is-"+q.visible())});var k=document.createElement("li");$(k).append($(p));$("#colvis").append($(k))});$("#show-hide").show();$(".dropdown").on("show.bs.dropdown",function(k){$(this).find(".dropdown-menu").first().stop(true,true).slideDown()});$(".dropdown").on("hide.bs.dropdown",function(k){$(this).find(".dropdown-menu").first().stop(true,true).slideUp()});$("#dataTable tbody").on("mousedown","tr",function(k){if(k.which===1){if(!$(this).hasClass("row-selected")){$(this).addClass("row-selected")}else{$(this).removeClass("row-selected")}}});$("label > input").addClass("form-control").addClass("minor-text");$("label > input").attr("placeholder","Search Results...");$(".loading").hide();$("#dataTable").show();$(".data_options").append($("#dataTable_filter"));$(".data_options").append($(".dt-buttons"));$(".dt-button").addClass("btn");$(".dt-button").addClass("btn-default");$("#core").css("display","block")}var e=[j,numberWithCommas(b.toFixed(2)),numberWithCommas(f.toFixed(2)),numberWithCommas(a.toFixed(2)),(c.toFixed(3)*100).toFixed(1)+"%",numberWithCommas(d)];var g=$("#dataTable").dataTable().fnAddData(e)}function refresh(){$("#noselect-object").html('<table id="dataTable" class="display"></table>');$(".dataTables_filter").remove();$(".dt-buttons").remove();$("#refresh-button").remove();secondsToRefresh=120;created=false;filtered=false;itemids=[];init()};