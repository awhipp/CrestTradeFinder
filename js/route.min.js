var thiz;var BUY_ORDER="buy";var SELL_ORDER="sell";var ESI_ENDPOINT="https://esi.evetech.net";var PAGE_MULTIPLE=50;function Route(b,a){this.startLocation=b;this.endLocations=a;this.buyOrders={};this.buyOrders.completePages=[];this.buyOrders.complete=false;this.buyOrders.pageBookend=PAGE_MULTIPLE;this.sellOrders={};this.totalProgress=0;this.itemIds=[];this.asyncChecker=null}Route.prototype.startRoute=function(){thiz=this;var c;var d=parseInt(this.startLocation.region);var b=parseInt(this.startLocation.station);for(c=1;c<=PAGE_MULTIPLE;c++){this.getBuyOrders(d,b,c,this.buyOrders)}for(var a=0;a<this.endLocations.length;a++){this.sellOrders[a]={};this.sellOrders[a].completePages=[];this.sellOrders[a].complete=false;this.sellOrders[a].pageBookend=PAGE_MULTIPLE;d=parseInt(this.endLocations[a].region);b=parseInt(this.endLocations[a].station);for(c=1;c<=PAGE_MULTIPLE;c++){this.getSellOrders(d,b,c,this.sellOrders[a])}}$("#selection").hide();this.asyncCheck()};Route.prototype.asyncCheck=function(){this.asyncChecker=setInterval(function(){thiz.executeOrders()},1000)};Route.prototype.marketEndpointBuilder=function(d,c,a){var b=ESI_ENDPOINT+"/latest/markets/"+d+"/orders/?datasource=tranquility&page="+c+"&order_type="+a+"&language=en-us";return b.replace(/\s/g,"")};Route.prototype.recalculateProgress=function(){var a=this.getNumberOfCompletePages(this.buyOrders);for(var b=0;b<this.sellOrders.length;b++){a+=this.getNumberOfCompletePages(this.sellOrders[b])}return a===0?1:a};Route.prototype.incrementProgress=function(b,a){if(this.totalProgress!==100){this.totalProgress=35*Math.log10(this.recalculateProgress());this.totalProgress=this.totalProgress>100?100:this.totalProgress;$(".loading").html("<b>Getting orders: "+this.totalProgress.toFixed(2)+"% complete</b>")}b.completePages[a]=true};Route.prototype.getBuyOrders=function(c,a,b,d){this.getOrders(c,a,b,d,BUY_ORDER)};Route.prototype.getSellOrders=function(c,a,b,d){this.getOrders(c,a,b,d,SELL_ORDER)};Route.prototype.getOrders=function(e,c,d,f,a){var b=this.marketEndpointBuilder(e,d,a);if(!f.completePages[d]){$.ajax({type:"get",url:b,dataType:"json",contentType:"application/json",async:true,success:function(k){thiz.incrementProgress(f,d);if(k.length===0&&!f.complete){f.complete=true;console.log("Completed "+c+" order fetch at "+d)}else{for(var h=0;h<k.length;h++){if(k[h]["location_id"]===c){var l=k[h]["type_id"];if(!f[l]){f[l]=[]}f[l].push(k[h])}}if(!f.complete&&thiz.getNumberOfCompletePages(f)===f.pageBookend){var j=d+1;f.pageBookend=(f.pageBookend+PAGE_MULTIPLE);for(var g=f.pageBookend;j<=g;j++){thiz.getOrders(e,c,j,f,a)}}}},error:function(g,i,h){displayError();thiz.incrementProgress(f,d)}})}};Route.prototype.getNumberOfCompletePages=function(a){var c=0;for(var b=0;b<a.completePages.length;b++){if(a.completePages[b]){c++}}return c};Route.prototype.checkOrdersComplete=function(){var a=(this.getNumberOfCompletePages(this.buyOrders)===this.buyOrders.pageBookend);var c=this.buyOrders.complete;for(var b=0;b<this.sellOrders.length;b++){a=a&&(this.getNumberOfCompletePages(this.sellOrders[b])===this.sellOrders[b].pageBookend);c=c&&this.sellOrders[b].complete}return(a&&c)};Route.prototype.executeOrders=function(){if(this.checkOrdersComplete()){clearInterval(this.asyncChecker);hideError();for(itemid in this.buyOrders){this.itemIds.push(itemid)}this.totalProgress=100;$(".loading").text("Getting orders: "+this.totalProgress.toFixed(2)+"% complete");console.log("finished")}};