var routes=[];function Route(b,a){this.startLocation=b;this.endLocations=a;this.buyOrders={};this.buyOrders.completePages=[];this.buyOrders.complete=false;this.buyOrders.pageBookend=PAGE_MULTIPLE;this.sellOrders={};this.itemIds=[];this.secondsToRefresh=60;this.asyncRefresher=null;this.asyncProgressUpdate=null;this.completed=false;routes.push(this);this.routeId=routes.length-1}Route.prototype.className=function(){return"Route"};Route.prototype.startRoute=function(){var d;var e=parseInt(this.startLocation.region);var c=parseInt(this.startLocation.station);for(d=1;d<=PAGE_MULTIPLE;d++){this.getSellOrders(e,c,d,this.buyOrders)}var a=0;for(var b=0;b<this.endLocations.length;b++){if(this.endLocations[b].station!==this.startLocation.station){this.sellOrders[a]={};this.sellOrders[a].completePages=[];this.sellOrders[a].complete=false;this.sellOrders[a].pageBookend=PAGE_MULTIPLE;e=parseInt(this.endLocations[b].region);c=parseInt(this.endLocations[b].station);for(d=1;d<=PAGE_MULTIPLE;d++){this.getBuyOrders(e,c,d,this.sellOrders[a])}a+=1}}$("#selection").hide()};Route.prototype.recalculateProgress=function(){var b=this.getNumberOfCompletePages(this.buyOrders);var a=0;for(var c=0;c<this.endLocations.length;c++){if(this.endLocations[c].station!==this.startLocation.station){b+=this.getNumberOfCompletePages(this.sellOrders[a]);a+=1}}return b<=0?1:35*Math.log10(b)};Route.prototype.getBuyOrders=function(c,a,b,d){this.getOrders(c,a,b,d,BUY_ORDER)};Route.prototype.getSellOrders=function(c,a,b,d){this.getOrders(c,a,b,d,SELL_ORDER)};Route.prototype.getOrders=function(f,d,e,g,a){var b=marketEndpointBuilder(f,e,a);var c=this;if(!g.completePages[e]){$.ajax({type:"get",url:b,dataType:"json",contentType:"application/json",async:true,success:function(l){incrementProgress(g,e);if(l.length===0&&!g.complete){g.complete=true;console.log("Completed "+d+" order fetch at "+e)}else{for(var j=0;j<l.length;j++){if(l[j]["location_id"]===d){var m=l[j]["type_id"];if(!g[m]){g[m]=[]}g[m].push(l[j])}}if(!g.complete&&c.getNumberOfCompletePages(g)===g.pageBookend){var k=e+1;g.pageBookend=(g.pageBookend+PAGE_MULTIPLE);for(var h=g.pageBookend;k<=h;k++){c.getOrders(f,d,k,g,a)}}else{c.executeOrders()}}},error:function(j,l,k){displayError();incrementProgress(g,e);if(!g.complete&&c.getNumberOfCompletePages(g)===g.pageBookend){var i=e+1;g.pageBookend=(g.pageBookend+PAGE_MULTIPLE);for(var h=g.pageBookend;i<=h;i++){c.getOrders(f,d,i,g,a)}}else{c.executeOrders()}}})}};Route.prototype.getNumberOfCompletePages=function(a){var c=0;for(var b=0;b<a.completePages.length;b++){if(a.completePages[b]){c++}}return c};Route.prototype.checkOrdersComplete=function(){var b=(this.getNumberOfCompletePages(this.buyOrders)===this.buyOrders.pageBookend);var d=this.buyOrders.complete;var a=0;for(var c=0;c<this.endLocations.length;c++){if(this.endLocations[c].station!==this.startLocation.station){b=b&&(this.getNumberOfCompletePages(this.sellOrders[a])===this.sellOrders[a].pageBookend);d=d&&this.sellOrders[a].complete;a+=1}}return(b&&d)};Route.prototype.executeOrders=function(){if(this.checkOrdersComplete()){hideError();for(itemId in this.buyOrders){if(itemId!=="completePages"&&itemId!=="complete"&&itemId!=="pageBookend"){this.itemIds.push(itemId)}}this.calculate()}};Route.prototype.clear=function(){this.startLocation=null;this.endLocations=null;this.buyOrders={};this.buyOrders.completePages=[];this.buyOrders.complete=false;this.buyOrders.pageBookend=PAGE_MULTIPLE;this.sellOrders={};this.itemIds=[];this.secondsToRefresh=60;clearInterval(this.asyncRefresher);clearInterval(this.asyncProgressUpdate)};Route.prototype.asyncRefresh=function(){var a=this;this.asyncRefresher=setInterval(function(){if(a.secondsToRefresh<=0){clearInterval(a.asyncRefresher);$("#refresh-timer").remove();$("#buyingFooter").append('<div id="refresh-button"><input type="button" class="btn btn-default" onclick="refresh()" value="Refresh Table with Last Query"/></div>')}else{if(rowAdded){$(".loading").hide()}else{$(".loading").text("No trades found for your filters.")}$("#refresh-timer").html("<p>Refresh allowed in: "+a.secondsToRefresh+" seconds.");a.secondsToRefresh--}},1000)};Route.prototype.asyncProgress=function(){var a=this;this.asyncProgressUpdate=setInterval(function(){getTotalProgress();if(totalProgress==100){clearInterval(a.asyncProgressUpdate);$("#buyingFooter").append('<div id="refresh-timer"></div>');$(".tableLoadingIcon").hide();if(!createdRefresher){createdRefresher=true;a.asyncRefresh()}}},2500)};Route.prototype.calculate=function(){this.asyncProgress();while(this.itemIds.length!=0){executingCount++;var a=this.itemIds.splice(0,1)[0];if(this.itemIds.length==0){this.completed=true}this.calculateNext(a)}};Route.prototype.calculateNext=function(h){var c=getMarketData(this.buyOrders[h],this.startLocation.station,SELL_ORDER,h,true);if(c.length>0){var d=false;var a=0;for(var e=0;e<this.endLocations.length;e++){if(this.endLocations[e].station!==this.startLocation.station){var f=this.sellOrders[a];var j=this.endLocations[e];if(f[h]){var g=getMarketData(f[h],j.station,BUY_ORDER,h,true);if(g.length>0){var b={};b.region=j.region;b.station=j.station;d=true;this.getItemInfo(h,c,g,b)}}a+=1}}if(!d){executingCount--}}else{executingCount--}};Route.prototype.getItemInfo=function(h,a,e,g){var d=[];for(var c=0;c<a.length;c++){for(var b=0;b<e.length;b++){var f=this.calculateRow(h,a[c][0],a[c][1],e[b][0],e[b][1],g);if(f.length>0){d.push(f)}}}if(d.length>0){d=d.sort(bestRowComparator);this.getItemWeight(h,this.createRowObject(d[0]))}else{executingCount--}};Route.prototype.calculateRow=function(j,d,g,h,i,c){if(d<h&&h>0){var f=h-d;var a;var b;var e;if(g>=i){e=i;a=i*f;b=d*i}else{e=g;a=g*f;b=d*g}var k=(h-d)/d;if(a>=threshold_profit&&(k.toFixed(3)*100).toFixed(1)>=threshold_roi&&b<=threshold_cost){return[j,d,e,b,c,a,k,h,f]}else{return[]}}return[]};Route.prototype.getItemWeight=function(f,e){if(itemCache[f]){var b=itemCache[f].name;var d=itemCache[f].weight;e.itemName=b;e.itemWeight=d;this.addRow(e);executingCount--}else{var c=this;var a=getWeightEndpointBuilder(f);$.ajax({type:"get",url:a,dataType:"json",async:true,cache:false,contentType:"application/json",success:function(i){executingCount--;var g=i.name;var h=i.packaged_volume;itemCache[f]={};itemCache[f].name=g;itemCache[f].weight=h;e.itemName=g;e.itemWeight=h;c.addRow(e)},error:function(h,g){if(h.status!=404&&h.statusText!=="parsererror"){c.getItemWeight(f,e)}else{executingCount--}}})}};Route.prototype.createRowObject=function(b){var a={};a.itemId=b[0];a.buyPrice=b[1];a.quantity=b[2];a.buyCost=b[3];a.sellToStation=b[4];a.totalProfit=b[5];a.roi=b[6];a.sellPrice=b[7];a.perItemProfit=b[8];return a};Route.prototype.addRow=function(c){var b=c.itemWeight*c.quantity;if(b>threshold_weight){return}if(isSpamItem(c.itemName)){return}createDataTable();var e=c.sellToStation.station+this.startLocation.station+c.itemId+"_investigate";var a=['<span id="'+e+'"data-itemId="'+c.itemId+'"data-itemName="'+c.itemName+'"data-routeId="'+this.routeId+'"data-sellStationId="'+c.sellToStation.station+'"><i class="fa fa-search-plus"></i></span>',c.itemName,this.startLocation.name,numberWithCommas(c.quantity),numberWithCommas(c.buyPrice.toFixed(2)),numberWithCommas(c.buyCost.toFixed(2)),getStationName(c.sellToStation.station),numberWithCommas(c.sellPrice.toFixed(2)),numberWithCommas(c.totalProfit.toFixed(2)),numberWithCommas(c.perItemProfit.toFixed(2)),(c.roi.toFixed(3)*100).toFixed(1)+"%",numberWithCommas(b.toFixed(2))];var d=$("#dataTable").dataTable().fnAddData(a);$("#dataTable").dataTable().fnGetNodes(d);$("#"+e).on("click",function(){var g=parseInt(this.dataset.itemid);var i=this.dataset.itemname;var h=routes[parseInt(this.dataset.routeid)].startLocation;var f=parseInt(this.dataset.sellstationid);open_popup(g,i,h,f)});rowAdded=true};